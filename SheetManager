/**
 * ì‹œíŠ¸ ê´€ë¦¬ ëª¨ë“ˆ v2.0
 * 
 * ì‹œíŠ¸ ì‚­ì œ, ì´ˆê¸°í™” ë“± ì‹œíŠ¸ ê´€ë¦¬ ê¸°ëŠ¥
 * ë°ì´í„° ì •ë¦¬ëŠ” SupplierLedger.gsì—ì„œ ì²˜ë¦¬
 */

// ===============================================
// ì‹œíŠ¸ ë³´í˜¸ ê´€ë¦¬
// ===============================================

/**
 * ë³´í˜¸í•´ì•¼ í•  ì‹œíŠ¸ ëª©ë¡
 */
function getProtectedSheetNames() {
  return [
    'ì´ ì •ë¦¬ í‘œ', 'ì´ì •ë¦¬í‘œ', 'ì´ ì •ë¦¬í‘œ', 'ì´ì •ë¦¬ í‘œ',
    'ì•½í’ˆ ì •ë¦¬ í‘œ', 'ì•½í’ˆì •ë¦¬í‘œ', 'ì•½í’ˆ ì •ë¦¬í‘œ', 'ì•½í’ˆì •ë¦¬ í‘œ',
    'ì‚¬ë£Œ ì •ë¦¬ í‘œ', 'ì‚¬ë£Œì •ë¦¬í‘œ', 'ì‚¬ë£Œ ì •ë¦¬í‘œ', 'ì‚¬ë£Œì •ë¦¬ í‘œ',
    '_Debug_Log', 'ì„ì‹œì‹œíŠ¸'
  ];
}

/**
 * ì‹œíŠ¸ê°€ ë³´í˜¸ ëŒ€ìƒì¸ì§€ í™•ì¸
 */
function isProtectedSheet(sheetName) {
  const protectedNames = getProtectedSheetNames();
  return protectedNames.some(protected => 
    sheetName.toLowerCase().includes(protected.toLowerCase())
  );
}

// ===============================================
// ì‹œíŠ¸ ì‚­ì œ ê¸°ëŠ¥
// ===============================================

/**
 * ê°€ì ¸ì˜¨ ì‹œíŠ¸ ì‚­ì œ (ë³´í˜¸ ì‹œíŠ¸ ì œì™¸)
 */
function deleteImportedSheets() {
  const ui = SpreadsheetApp.getUi();
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  
  // ì‚­ì œ ê°€ëŠ¥í•œ ì‹œíŠ¸ ì°¾ê¸°
  const deletableSheets = sheets.filter(sheet => !isProtectedSheet(sheet.getName()));
  
  if (deletableSheets.length === 0) {
    ui.alert('ì‚­ì œí•  ì‹œíŠ¸ ì—†ìŒ', 'ì‚­ì œ ê°€ëŠ¥í•œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    return;
  }
  
  // ì‚­ì œ í™•ì¸
  const response = ui.alert(
    'ì‹œíŠ¸ ì‚­ì œ í™•ì¸',
    `${deletableSheets.length}ê°œ ì‹œíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
    deletableSheets.slice(0, 10).map(s => 'â€¢ ' + s.getName()).join('\n') +
    (deletableSheets.length > 10 ? `\n... ì™¸ ${deletableSheets.length - 10}ê°œ` : ''),
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    performSheetDeletion(deletableSheets);
  }
}

/**
 * ì‹œíŠ¸ ì‚­ì œ ì‹¤í–‰
 */
function performSheetDeletion(sheetsToDelete) {
  const ui = SpreadsheetApp.getUi();
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  
  // ìµœì†Œ 1ê°œ ì‹œíŠ¸ëŠ” ë‚¨ê²¨ì•¼ í•¨
  const allSheets = spreadsheet.getSheets();
  if (sheetsToDelete.length >= allSheets.length) {
    spreadsheet.insertSheet('ì„ì‹œì‹œíŠ¸');
  }
  
  let deletedCount = 0;
  const errors = [];
  
  sheetsToDelete.forEach(sheet => {
    try {
      spreadsheet.deleteSheet(sheet);
      deletedCount++;
      logDebug('ì‹œíŠ¸ ì‚­ì œ', sheet.getName());
    } catch (error) {
      errors.push(`${sheet.getName()}: ${error.toString()}`);
    }
  });
  
  // ê²°ê³¼ í‘œì‹œ
  if (errors.length > 0) {
    ui.alert(
      'ë¶€ë¶„ ì™„ë£Œ',
      `${deletedCount}ê°œ ì‹œíŠ¸ ì‚­ì œë¨\n\nì˜¤ë¥˜:\n${errors.join('\n')}`,
      ui.ButtonSet.OK
    );
  } else {
    ui.alert('ì™„ë£Œ', `${deletedCount}ê°œ ì‹œíŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, ui.ButtonSet.OK);
  }
}

// ===============================================
// ì‹œíŠ¸ ì´ˆê¸°í™”
// ===============================================

/**
 * ì „ì²´ ì´ˆê¸°í™” (ë¹ ë¥¸ ë²„ì „) - UI ì—†ì´ ì‹¤í–‰
 */
function quickReset() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  
  // í•„ìˆ˜ ì‹œíŠ¸ í™•ì¸ ë° ìƒì„±
  const mainProtectedSheets = ['ì´ ì •ë¦¬ í‘œ', 'ì•½í’ˆ ì •ë¦¬ í‘œ', 'ì‚¬ë£Œ ì •ë¦¬ í‘œ'];
  
  mainProtectedSheets.forEach(sheetName => {
    let found = false;
    
    // ë‹¤ì–‘í•œ í˜•ì‹ í™•ì¸
    const variations = [
      sheetName,
      sheetName.replace(/ /g, ''),
      sheetName.replace('í‘œ', ' í‘œ')
    ];
    
    for (const variation of variations) {
      if (spreadsheet.getSheetByName(variation)) {
        found = true;
        break;
      }
    }
    
    if (!found) {
      const newSheet = spreadsheet.insertSheet(sheetName);
      
      // ì´ ì •ë¦¬ í‘œ ì´ˆê¸° ì„¤ì •
      if (sheetName === 'ì´ ì •ë¦¬ í‘œ') {
        newSheet.getRange('C1').setValue('ê¸°ì¤€ ë‚ ì§œ');
        newSheet.getRange('D1').setValue(new Date().getFullYear());
        newSheet.getRange('F1').setValue(new Date().getMonth() + 1);
      }
      
      logDebug('ì‹œíŠ¸ ìƒì„±', sheetName);
    }
  });
  
  // ì‚­ì œí•  ì‹œíŠ¸ ì°¾ê¸°
  let deletedCount = 0;
  
  sheets.forEach(sheet => {
    if (!isProtectedSheet(sheet.getName())) {
      try {
        spreadsheet.deleteSheet(sheet);
        deletedCount++;
      } catch (error) {
        logDebug('ì‚­ì œ ì‹¤íŒ¨', sheet.getName());
      }
    }
  });
  
  return deletedCount;
}

/**
 * ì „ì²´ ì´ˆê¸°í™” - ì •ë¦¬ í‘œë“¤ë§Œ ë‚¨ê¸°ê¸° (UI í¬í•¨)
 */
function resetToSummarySheetOnly() {
  const ui = SpreadsheetApp.getUi();
  
  // ì´ì¤‘ í™•ì¸
  const warning = ui.alert(
    'âš ï¸ ì „ì²´ ì´ˆê¸°í™”',
    'ì •ë¦¬ í‘œë¥¼ ì œì™¸í•œ ëª¨ë“  ì‹œíŠ¸ê°€ ì‚­ì œë©ë‹ˆë‹¤!\n\n' +
    'ë³´ì¡´ë˜ëŠ” ì‹œíŠ¸:\n' +
    'â€¢ ì´ ì •ë¦¬ í‘œ\n' +
    'â€¢ ì•½í’ˆ ì •ë¦¬ í‘œ\n' +
    'â€¢ ì‚¬ë£Œ ì •ë¦¬ í‘œ\n\n' +
    'ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    ui.ButtonSet.YES_NO
  );
  
  if (warning !== ui.Button.YES) return;
  
  const confirm = ui.alert(
    'ğŸ”´ ìµœì¢… í™•ì¸',
    'ì •ë§ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì‹œíŠ¸ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!',
    ui.ButtonSet.YES_NO
  );
  
  if (confirm !== ui.Button.YES) return;
  
  try {
    const deletedCount = quickReset();
    const baseDate = getBaseYearMonth();
    
    ui.alert(
      'âœ… ì´ˆê¸°í™” ì™„ë£Œ',
      `${deletedCount}ê°œ ì‹œíŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
      `í˜„ì¬ ì„¤ì •:\n` +
      `â€¢ ê¸°ì¤€ ë…„ì›”: ${baseDate.year}ë…„ ${baseDate.month}ì›”\n\n` +
      `ì´ì œ ìƒˆë¡œìš´ ì›” ë§ˆê° ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', `ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ${error.toString()}`, ui.ButtonSet.OK);
  }
}

// ===============================================
// ì‹œíŠ¸ ìƒíƒœ í™•ì¸
// ===============================================

/**
 * ì‹œíŠ¸ ìƒíƒœ í™•ì¸
 */
function checkSheetStatus() {
  const ui = SpreadsheetApp.getUi();
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  const baseDate = getBaseYearMonth();
  
  // ì‹œíŠ¸ ë¶„ë¥˜
  const categorized = categorizeSheets(sheets);
  
  // HTML ë³´ê³ ì„œ ìƒì„±
  const html = createSheetStatusHTML(categorized, baseDate);
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(500);
  
  ui.showModalDialog(htmlOutput, 'ì‹œíŠ¸ ìƒíƒœ ë³´ê³ ì„œ');
}

/**
 * ì‹œíŠ¸ ë¶„ë¥˜
 */
function categorizeSheets(sheets) {
  const categories = {
    protected: [],
    supplierLedgers: [],
    purchaseRecords: [],
    invoices: [],
    feedRecords: [],
    other: []
  };
  
  sheets.forEach(sheet => {
    const name = sheet.getName();
    const nameLower = name.toLowerCase();
    
    if (isProtectedSheet(name)) {
      categories.protected.push(name);
    } else if (nameLower.includes('ê±°ë˜ì²˜ì›ì¥') || nameLower.includes('ì›ì¥')) {
      categories.supplierLedgers.push(name);
    } else if (nameLower.includes('êµ¬ë§¤ë‚´ì—­')) {
      categories.purchaseRecords.push(name);
    } else if (nameLower.includes('ì²­êµ¬ì„œ')) {
      categories.invoices.push(name);
    } else if (nameLower.includes('ì‚¬ë£Œë‚´ì—­')) {
      categories.feedRecords.push(name);
    } else {
      categories.other.push(name);
    }
  });
  
  return categories;
}

/**
 * ì‹œíŠ¸ ìƒíƒœ HTML ìƒì„±
 */
function createSheetStatusHTML(categories, baseDate) {
  const totalSheets = Object.values(categories).reduce((sum, arr) => sum + arr.length, 0);
  
  return `
    <style>
      body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; }
      h2 { color: #1a73e8; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
      .info-box { background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
      .category { margin-bottom: 20px; }
      .category-title { font-weight: bold; color: #333; margin-bottom: 8px; }
      .sheet-list { margin-left: 20px; }
      .sheet-item { color: #666; margin: 4px 0; }
      .empty { color: #999; font-style: italic; }
      .stats { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 20px; }
    </style>
    
    <h2>ğŸ“Š ì‹œíŠ¸ ìƒíƒœ ë³´ê³ ì„œ</h2>
    
    <div class="info-box">
      <strong>ê¸°ì¤€ ë…„ì›”:</strong> ${baseDate.year}ë…„ ${baseDate.month}ì›”<br>
      <strong>ì „ì²´ ì‹œíŠ¸:</strong> ${totalSheets}ê°œ
    </div>
    
    <div class="category">
      <div class="category-title">ğŸ”’ ë³´í˜¸ëœ ì‹œíŠ¸ (${categories.protected.length}ê°œ)</div>
      <div class="sheet-list">
        ${categories.protected.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('') || '<div class="empty">ì—†ìŒ</div>'}
      </div>
    </div>
    
    <div class="category">
      <div class="category-title">ğŸ“‹ ê±°ë˜ì²˜ì›ì¥ (${categories.supplierLedgers.length}ê°œ)</div>
      <div class="sheet-list">
        ${categories.supplierLedgers.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('') || '<div class="empty">ì—†ìŒ</div>'}
      </div>
    </div>
    
    <div class="category">
      <div class="category-title">ğŸ“„ êµ¬ë§¤ë‚´ì—­ì„œ (${categories.purchaseRecords.length}ê°œ)</div>
      <div class="sheet-list">
        ${categories.purchaseRecords.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('') || '<div class="empty">ì—†ìŒ</div>'}
      </div>
    </div>
    
    <div class="category">
      <div class="category-title">ğŸ§¾ ì²­êµ¬ì„œ (${categories.invoices.length}ê°œ)</div>
      <div class="sheet-list">
        ${categories.invoices.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('') || '<div class="empty">ì—†ìŒ</div>'}
      </div>
    </div>
    
    <div class="category">
      <div class="category-title">ğŸŒ¾ ì‚¬ë£Œë‚´ì—­ì„œ (${categories.feedRecords.length}ê°œ)</div>
      <div class="sheet-list">
        ${categories.feedRecords.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('') || '<div class="empty">ì—†ìŒ</div>'}
      </div>
    </div>
    
    ${categories.other.length > 0 ? `
      <div class="category">
        <div class="category-title">â“ ê¸°íƒ€ (${categories.other.length}ê°œ)</div>
        <div class="sheet-list">
          ${categories.other.map(name => `<div class="sheet-item">â€¢ ${name}</div>`).join('')}
        </div>
      </div>
    ` : ''}
    
    <div class="stats">
      <strong>í†µê³„:</strong><br>
      â€¢ ë°ì´í„° ì‹œíŠ¸: ${totalSheets - categories.protected.length}ê°œ<br>
      â€¢ ê±°ë˜ì²˜ì›ì¥ ì²˜ë¦¬ ê°€ëŠ¥: ${categories.supplierLedgers.length}ê°œ
    </div>
  `;
}
