/**
 * ì‚¬ë£Œ ë°ì´í„° ìë™ ì²˜ë¦¬ ì‹œìŠ¤í…œ
 * ì´ ì •ë¦¬ í‘œì˜ ì‚¬ë£Œ í‘œì™€ ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œë¥¼ ìë™ìœ¼ë¡œ ì±„ìš°ëŠ” ê¸°ëŠ¥
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ì—ì„œ ì‚¬ë£Œ ë°ì´í„° ì¶”ì¶œ ë° ì§‘ê³„
 * 2. ì´ ì •ë¦¬ í‘œì˜ ì‚¬ë£Œ í‘œ ìë™ ì±„ìš°ê¸° (B4:F16)
 * 3. ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ (B18:F30)
 * 4. ë¹ˆ í–‰ ìë™ ìˆ¨ê¸°ê¸° ê¸°ëŠ¥
 *    - ì‚¬ë£Œ í‘œ: Dì—´ê³¼ Eì—´ì´ ëª¨ë‘ ê³µë€ì¸ í–‰ ìˆ¨ê¸°ê¸°
 *    - êµ¬ë§¤ì‹¤ì  í‘œ: Dì—´ì´ ê³µë€ì¸ í–‰ ìˆ¨ê¸°ê¸°
 * 5. ê³„íš ëŒ€ë¹„ ì§‘í–‰ìœ¨ ë° ì „ì›” ëŒ€ë¹„ ê³„ì‚°
 * 
 * í…Œì´ë¸” êµ¬ì¡°:
 * - ì‚¬ë£Œ í‘œ: B4:F16
 *   Bì—´: í’ˆëª…
 *   Cì—´: ë‹¨ê°€(ì›)
 *   Dì—´: êµ¬ì…ëŸ‰(kg)
 *   Eì—´: êµ¬ì…ê¸ˆì•¡(ì›)
 *   Fì—´: ë¹„ê³ 
 * 
 * - ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ: B18:F30
 *   Bì—´: ì›”
 *   Cì—´: ê³„íšê¸ˆì•¡(ì›)
 *   Dì—´: êµ¬ë§¤ì‹¤ì (ì›)
 *   Eì—´: ê³„íšëŒ€ë¹„(%)
 *   Fì—´: ì „ì›”ëŒ€ë¹„(%)
 * 
 * ìë™ í–‰ ìˆ¨ê¸°ê¸° ê·œì¹™:
 * - processFeedData() ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸°
 * - ì‚¬ë£Œ í‘œ: êµ¬ì…ëŸ‰(D)ê³¼ êµ¬ì…ê¸ˆì•¡(E)ì´ ëª¨ë‘ ì—†ëŠ” í–‰
 * - êµ¬ë§¤ì‹¤ì  í‘œ: êµ¬ë§¤ì‹¤ì (D)ì´ ì—†ëŠ” í–‰
 */

/**
 * ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ - ì‚¬ë£Œ ë°ì´í„° ì „ì²´ ì²˜ë¦¬
 */
function processFeedData() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    console.log('=== ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ ===');
    
    // 1. ì´ ì •ë¦¬ í‘œ ì°¾ê¸°
    const summarySheet = findSummarySheet();
    if (!summarySheet) {
      ui.alert('ì˜¤ë¥˜', 'ì´ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
      return;
    }
    
    // 2. ê¸°ì¤€ ë…„ì›” ê°€ì ¸ì˜¤ê¸°
    const baseYearMonth = getBaseYearMonthFromSheet(summarySheet);
    console.log(`ê¸°ì¤€ ë…„ì›”: ${baseYearMonth.year}ë…„ ${baseYearMonth.month}ì›”`);
    
    // 3. ì‚¬ë£Œ í‘œ ë°ì´í„° ì²˜ë¦¬ (B4:F16)
    const feedTableResult = processFeedTable(summarySheet, baseYearMonth);
    
    // 4. ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ (B18:F30)
    const purchaseResult = updateFeedPurchaseRecord(summarySheet, baseYearMonth);
    
    // 5. ë¹ˆ í–‰ ìë™ ìˆ¨ê¸°ê¸°
    const hideResult = autoHideEmptyRows(summarySheet);
    
    // 6. ê²°ê³¼ ë³´ê³ 
    const message = `ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ!\n\n` +
                   `ğŸ“Š ì‚¬ë£Œ í‘œ (B4:F16):\n` +
                   `  - í“¨ë¦¬ë‚˜: ${feedTableResult.purina.count}ê°œ í’ˆëª©\n` +
                   `  - ì œì¶•ì„¬ìœ ì§ˆ: ${feedTableResult.fiber.count}ê°œ í’ˆëª©\n` +
                   `  - ì´ êµ¬ì…ëŸ‰: ${formatNumber(feedTableResult.totalWeight)}kg\n` +
                   `  - ì´ êµ¬ì…ê¸ˆì•¡: ${formatNumber(feedTableResult.totalAmount)}ì›\n` +
                   `  - ìˆ¨ê¸´ ë¹ˆ í–‰: ${hideResult.feedTableHidden}ê°œ\n\n` +
                   `ğŸ“ˆ êµ¬ë§¤ì‹¤ì  í‘œ (B18:F30):\n` +
                   `  - ${baseYearMonth.month}ì›” ì‹¤ì  ì—…ë°ì´íŠ¸\n` +
                   `  - ê³„íš ëŒ€ë¹„: ${purchaseResult.executionRate}\n` +
                   `  - ì „ì›” ëŒ€ë¹„: ${purchaseResult.monthOverMonth}\n` +
                   `  - ìˆ¨ê¸´ ë¹ˆ í–‰: ${hideResult.purchaseTableHidden}ê°œ`;
    
    ui.alert('âœ… ì™„ë£Œ', message, ui.ButtonSet.OK);
    console.log('=== ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ ===');
    
  } catch (error) {
    console.error('ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    ui.alert('ì˜¤ë¥˜', `ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * ì‚¬ë£Œ í‘œ ë°ì´í„° ì²˜ë¦¬ (B4:F16)
 */
function processFeedTable(summarySheet, baseYearMonth) {
  console.log('--- ì‚¬ë£Œ í‘œ ì²˜ë¦¬ ì‹œì‘ ---');
  
  const result = {
    purina: { count: 0, amount: 0 },
    fiber: { count: 0, amount: 0 },
    totalWeight: 0,
    totalAmount: 0
  };
  
  try {
    // 1. í“¨ë¦¬ë‚˜ ë°ì´í„° ì²˜ë¦¬
    const purinaData = processPurinaData(baseYearMonth);
    if (purinaData.items.length > 0) {
      updateFeedTableData(summarySheet, purinaData.items, 'purina');
      result.purina.count = purinaData.items.length;
      result.purina.amount = purinaData.totalAmount;
    }
    
    // 2. ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬
    const fiberData = processFiberData(baseYearMonth);
    if (fiberData.items.length > 0) {
      updateFeedTableData(summarySheet, fiberData.items, 'fiber');
      result.fiber.count = fiberData.items.length;
      result.fiber.amount = fiberData.totalAmount;
    }
    
    // 3. í•©ê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    updateFeedTableTotals(summarySheet);
    
    // 4. ì‚¬ë£Œ í‘œ ì „ì²´ ì„œì‹ ì ìš©
    applyFeedTableFormats(summarySheet);
    
    // 5. ê²°ê³¼ ìˆ˜ì§‘
    const d16Value = summarySheet.getRange('D16').getValue();
    const e16Value = summarySheet.getRange('E16').getValue();
    result.totalWeight = d16Value || 0;
    result.totalAmount = e16Value || 0;
    
    console.log('ì‚¬ë£Œ í‘œ ì²˜ë¦¬ ì™„ë£Œ:', result);
    return result;
    
  } catch (error) {
    console.error('ì‚¬ë£Œ í‘œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * í“¨ë¦¬ë‚˜ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬
 */
function processPurinaData(baseYearMonth) {
  console.log('í“¨ë¦¬ë‚˜ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  
  // ê±°ë˜ì²˜ì›ì¥YY.MM + í“¨ë¦¬ë‚˜ ì‹œíŠ¸ ì°¾ê¸°
  const targetSheets = sheets.filter(sheet => {
    const name = sheet.getName();
    const pattern1 = `ê±°ë˜ì²˜ì›ì¥${baseYearMonth.yearShort}.${baseYearMonth.month}`;
    const pattern2 = `ê±°ë˜ì²˜ì›ì¥${baseYearMonth.yearShort}.${baseYearMonth.monthShort}`;
    
    return (name.includes(pattern1) || name.includes(pattern2)) && name.includes('í“¨ë¦¬ë‚˜');
  });
  
  if (targetSheets.length === 0) {
    console.log('í“¨ë¦¬ë‚˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return { items: [], totalAmount: 0 };
  }
  
  const aggregatedData = {};
  
  targetSheets.forEach(sheet => {
    console.log(`ì²˜ë¦¬ ì¤‘: ${sheet.getName()}`);
    
    // 3ë²ˆì§¸ í–‰ì—ì„œ í—¤ë” ì°¾ê¸°
    const headers = sheet.getRange(3, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // í•„ìš”í•œ ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
    const colIndexes = {
      itemName: findHeaderIndex(headers, ['í’ˆëª…/ì ìš”', 'í’ˆëª…', 'ì ìš”']),
      weight: findHeaderIndex(headers, ['êµ¬ì…ëŸ‰(kg)', 'êµ¬ì…ëŸ‰', 'ì¤‘ëŸ‰']),
      unitPrice: findHeaderIndex(headers, ['ë‹¨ê°€']),
      supplyAmount: findHeaderIndex(headers, ['ê³µê¸‰ê°€ì•¡', 'ê³µê¸‰ê°€'])
    };
    
    if (colIndexes.itemName === -1) {
      console.log('í’ˆëª…/ì ìš” ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return;
    }
    
    // ë°ì´í„° ì½ê¸° (4í–‰ë¶€í„°)
    const lastRow = sheet.getLastRow();
    if (lastRow < 4) return;
    
    const data = sheet.getRange(4, 1, lastRow - 3, sheet.getLastColumn()).getValues();
    
    // ë°ì´í„° ì§‘ê³„
    data.forEach(row => {
      const itemName = normalizeItemName(row[colIndexes.itemName]);
      if (!itemName || itemName === 'í•©ê³„') return;
      
      if (!aggregatedData[itemName]) {
        aggregatedData[itemName] = {
          weight: 0,
          amount: 0,
          unitPrice: 0
        };
      }
      
      // êµ¬ì…ëŸ‰ í•©ì‚°
      if (colIndexes.weight !== -1) {
        const weight = parseFloat(row[colIndexes.weight]) || 0;
        aggregatedData[itemName].weight += weight;
      }
      
      // ê³µê¸‰ê°€ì•¡ í•©ì‚°
      if (colIndexes.supplyAmount !== -1) {
        const amount = parseFloat(row[colIndexes.supplyAmount]) || 0;
        aggregatedData[itemName].amount += amount;
      }
      
      // ë‹¨ê°€ (ë§ˆì§€ë§‰ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
      if (colIndexes.unitPrice !== -1 && row[colIndexes.unitPrice]) {
        aggregatedData[itemName].unitPrice = parseFloat(row[colIndexes.unitPrice]) || 0;
      }
    });
  });
  
  // ê²°ê³¼ ì •ë¦¬
  const items = Object.keys(aggregatedData).map(itemName => ({
    name: itemName,
    weight: aggregatedData[itemName].weight,
    unitPrice: aggregatedData[itemName].unitPrice,
    amount: aggregatedData[itemName].amount
  }));
  
  const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);
  
  console.log(`í“¨ë¦¬ë‚˜ ì²˜ë¦¬ ì™„ë£Œ: ${items.length}ê°œ í’ˆëª©, ì´ ${formatNumber(totalAmount)}ì›`);
  return { items, totalAmount };
}

/**
 * ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬
 */
function processFiberData(baseYearMonth) {
  console.log('ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  
  // ê±°ë˜ì²˜ì›ì¥YY.MM + ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ì‹œíŠ¸ ì°¾ê¸°
  const targetSheets = sheets.filter(sheet => {
    const name = sheet.getName();
    const pattern1 = `ê±°ë˜ì²˜ì›ì¥${baseYearMonth.yearShort}.${baseYearMonth.month}`;
    const pattern2 = `ê±°ë˜ì²˜ì›ì¥${baseYearMonth.yearShort}.${baseYearMonth.monthShort}`;
    
    return (name.includes(pattern1) || name.includes(pattern2)) && name.includes('ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ');
  });
  
  if (targetSheets.length === 0) {
    console.log('ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return { items: [], totalAmount: 0 };
  }
  
  const aggregatedData = {};
  
  targetSheets.forEach(sheet => {
    console.log(`ì²˜ë¦¬ ì¤‘: ${sheet.getName()}`);
    
    // 3ë²ˆì§¸ í–‰ì—ì„œ í—¤ë” ì°¾ê¸°
    const headers = sheet.getRange(3, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // í•„ìš”í•œ ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
    const colIndexes = {
      itemName: findHeaderIndex(headers, ['í’ˆëª…/ì ìš”', 'í’ˆëª…', 'ì ìš”']),
      weight: findHeaderIndex(headers, ['êµ¬ì…ëŸ‰(kg)', 'êµ¬ì…ëŸ‰', 'ì¤‘ëŸ‰']),
      unitPrice: findHeaderIndex(headers, ['ë‹¨ê°€']),
      supplyAmount: findHeaderIndex(headers, ['ê³µê¸‰ê°€ì•¡', 'ê³µê¸‰ê°€'])
    };
    
    if (colIndexes.itemName === -1) {
      console.log('í’ˆëª…/ì ìš” ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return;
    }
    
    // ë°ì´í„° ì½ê¸° (4í–‰ë¶€í„°)
    const lastRow = sheet.getLastRow();
    if (lastRow < 4) return;
    
    const data = sheet.getRange(4, 1, lastRow - 3, sheet.getLastColumn()).getValues();
    
    // ë°ì´í„° ì§‘ê³„ (ì£¼ë¡œ ì—°ë§¥)
    data.forEach(row => {
      const itemName = normalizeItemName(row[colIndexes.itemName]);
      if (!itemName || itemName === 'í•©ê³„') return;
      
      if (!aggregatedData[itemName]) {
        aggregatedData[itemName] = {
          weight: 0,
          amount: 0,
          unitPrice: 0
        };
      }
      
      // êµ¬ì…ëŸ‰ í•©ì‚°
      if (colIndexes.weight !== -1) {
        const weight = parseFloat(row[colIndexes.weight]) || 0;
        aggregatedData[itemName].weight += weight;
      }
      
      // ê³µê¸‰ê°€ì•¡ í•©ì‚°
      if (colIndexes.supplyAmount !== -1) {
        const amount = parseFloat(row[colIndexes.supplyAmount]) || 0;
        aggregatedData[itemName].amount += amount;
      }
      
      // ë‹¨ê°€
      if (colIndexes.unitPrice !== -1 && row[colIndexes.unitPrice]) {
        aggregatedData[itemName].unitPrice = parseFloat(row[colIndexes.unitPrice]) || 0;
      }
    });
  });
  
  // ê²°ê³¼ ì •ë¦¬
  const items = Object.keys(aggregatedData).map(itemName => ({
    name: itemName,
    weight: aggregatedData[itemName].weight,
    unitPrice: aggregatedData[itemName].unitPrice,
    amount: aggregatedData[itemName].amount
  }));
  
  const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);
  
  console.log(`ì œì¶•ì„¬ìœ ì§ˆ ì²˜ë¦¬ ì™„ë£Œ: ${items.length}ê°œ í’ˆëª©, ì´ ${formatNumber(totalAmount)}ì›`);
  return { items, totalAmount };
}

/**
 * ì‚¬ë£Œ í‘œì— ë°ì´í„° ì—…ë°ì´íŠ¸
 */
function updateFeedTableData(summarySheet, items, sourceType) {
  console.log(`ì‚¬ë£Œ í‘œ ì—…ë°ì´íŠ¸: ${sourceType}`);
  
  // B5:B15 ë²”ìœ„ì˜ í’ˆëª… ê°€ì ¸ì˜¤ê¸°
  const itemNames = summarySheet.getRange('B5:B15').getValues();
  
  items.forEach(item => {
    // í’ˆëª… ë§¤ì¹­ (Bì—´ì—ì„œ ì°¾ê¸°)
    for (let i = 0; i < itemNames.length; i++) {
      const sheetItemName = normalizeItemName(itemNames[i][0]);
      
      if (sheetItemName === item.name) {
        const rowNum = 5 + i; // ì‹¤ì œ í–‰ ë²ˆí˜¸
        
        // Cì—´: ë‹¨ê°€
        if (item.unitPrice > 0) {
          summarySheet.getRange(`C${rowNum}`).setValue(item.unitPrice);
        }
        
        // Dì—´: êµ¬ì…ëŸ‰(kg)
        if (item.weight > 0) {
          summarySheet.getRange(`D${rowNum}`).setValue(item.weight);
        }
        
        // Eì—´: êµ¬ì…ê¸ˆì•¡(ì›)
        if (item.amount > 0) {
          summarySheet.getRange(`E${rowNum}`).setValue(item.amount);
        }
        
        console.log(`  ${item.name}: ë‹¨ê°€=${formatNumber(item.unitPrice)}, ì¤‘ëŸ‰=${formatNumber(item.weight)}kg, ê¸ˆì•¡=${formatNumber(item.amount)}ì›`);
        break;
      }
    }
  });
}

/**
 * ì‚¬ë£Œ í‘œ í•©ê³„ ì—…ë°ì´íŠ¸
 */
function updateFeedTableTotals(summarySheet) {
  console.log('ì‚¬ë£Œ í‘œ í•©ê³„ ê³„ì‚°');
  
  // D5:D15 í•©ê³„ â†’ D16
  const weightRange = summarySheet.getRange('D5:D15');
  const weights = weightRange.getValues();
  const totalWeight = weights.reduce((sum, row) => sum + (parseFloat(row[0]) || 0), 0);
  summarySheet.getRange('D16').setValue(totalWeight);
  
  // E5:E15 í•©ê³„ â†’ E16
  const amountRange = summarySheet.getRange('E5:E15');
  const amounts = amountRange.getValues();
  const totalAmount = amounts.reduce((sum, row) => sum + (parseFloat(row[0]) || 0), 0);
  summarySheet.getRange('E16').setValue(totalAmount);
  
  console.log(`  ì´ êµ¬ì…ëŸ‰: ${formatNumber(totalWeight)}kg`);
  console.log(`  ì´ êµ¬ì…ê¸ˆì•¡: ${formatNumber(totalAmount)}ì›`);
}

/**
 * ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ (B18:F30)
 */
function updateFeedPurchaseRecord(summarySheet, baseYearMonth) {
  console.log('--- ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ ---');
  
  const result = {
    executionRate: '0%',
    monthOverMonth: '0%'
  };
  
  try {
    // 1. ì‚¬ë£Œ ì •ë¦¬ í‘œ ì°¾ê¸°
    const feedSheet = findFeedSheet();
    if (!feedSheet) {
      console.log('ì‚¬ë£Œ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return result;
    }
    
    // 2. í˜„ì¬ ì›” í–‰ ì°¾ê¸° (B19:B30) - ìƒˆ ìœ„ì¹˜
    const monthColumn = summarySheet.getRange('B19:B30').getValues();
    let targetRow = -1;
    const targetMonth = parseInt(baseYearMonth.month) + 'ì›”';
    
    for (let i = 0; i < monthColumn.length; i++) {
      if (monthColumn[i][0] === targetMonth) {
        targetRow = 19 + i;  // 19í–‰ë¶€í„° ì‹œì‘
        break;
      }
    }
    
    if (targetRow === -1) {
      console.log(`${targetMonth} í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
      return result;
    }
    
    // 3. ê³„íš ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (ì‚¬ë£Œ ì •ë¦¬ í‘œ C4:O5)
    const planHeaders = feedSheet.getRange('C4:O4').getValues()[0];
    let planAmount = 0;
    
    for (let i = 0; i < planHeaders.length; i++) {
      if (planHeaders[i] === targetMonth) {
        const planValue = feedSheet.getRange(5, 3 + i).getValue();
        planAmount = (parseFloat(planValue) || 0) * 1000; // ì²œì› ë‹¨ìœ„ë¥¼ ì› ë‹¨ìœ„ë¡œ
        break;
      }
    }
    
    // 4. ì‹¤ì  ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (E16)
    const actualAmount = summarySheet.getRange('E16').getValue() || 0;
    
    // 5. ê°’ ì—…ë°ì´íŠ¸
    // Cì—´: ê³„íšê¸ˆì•¡ (ê¸°ì¡´ Iì—´)
    if (planAmount > 0) {
      summarySheet.getRange(`C${targetRow}`).setValue(planAmount);
    }
    
    // Dì—´: êµ¬ë§¤ì‹¤ì  (ê¸°ì¡´ Jì—´)
    summarySheet.getRange(`D${targetRow}`).setValue(actualAmount);
    
    // Eì—´: ê³„íš ëŒ€ë¹„ ì§‘í–‰ìœ¨ (D/C) (ê¸°ì¡´ Kì—´)
    if (planAmount > 0) {
      const executionRate = actualAmount / planAmount;
      summarySheet.getRange(`E${targetRow}`).setValue(executionRate);
      result.executionRate = Math.round(executionRate * 100) + '%';
    }
    
    // Fì—´: ì „ì›” ëŒ€ë¹„ (ê¸°ì¡´ Lì—´)
    const prevMonth = baseYearMonth.prevMonth + 'ì›”';
    let prevMonthRow = -1;
    
    for (let i = 0; i < monthColumn.length; i++) {
      if (monthColumn[i][0] === prevMonth) {
        prevMonthRow = 19 + i;  // ìƒˆ ìœ„ì¹˜ ê¸°ì¤€
        break;
      }
    }
    
    if (prevMonthRow !== -1) {
      const prevActual = summarySheet.getRange(`D${prevMonthRow}`).getValue() || 0;
      if (prevActual > 0) {
        const monthOverMonth = actualAmount / prevActual;
        summarySheet.getRange(`F${targetRow}`).setValue(monthOverMonth);
        result.monthOverMonth = Math.round(monthOverMonth * 100) + '%';
      }
    }
    
    // 6. ì„œì‹ ì ìš© (ìƒˆ ìœ„ì¹˜)
    applyPurchaseTableFormats(summarySheet, targetRow);
    
    console.log(`êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${targetMonth}`);
    console.log(`  ê³„íš: ${formatNumber(planAmount)}ì›`);
    console.log(`  ì‹¤ì : ${formatNumber(actualAmount)}ì›`);
    console.log(`  ì§‘í–‰ìœ¨: ${result.executionRate}`);
    console.log(`  ì „ì›”ëŒ€ë¹„: ${result.monthOverMonth}`);
    
    return result;
    
  } catch (error) {
    console.error('êµ¬ë§¤ì‹¤ì  í‘œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    return result;
  }
}

/**
 * êµ¬ë§¤ì‹¤ì  í‘œ ìˆ«ì ì„œì‹ ì ìš© (ìƒˆ ìœ„ì¹˜: B18:F30)
 */
function applyPurchaseTableFormats(sheet, row) {
  // C, Dì—´: ì²œ ë‹¨ìœ„ ì½¤ë§ˆ (ê³„íšê¸ˆì•¡, êµ¬ë§¤ì‹¤ì )
  sheet.getRange(`C${row}:D${row}`).setNumberFormat('#,##0');
  
  // E, Fì—´: ë°±ë¶„ìœ¨ (ê³„íšëŒ€ë¹„, ì „ì›”ëŒ€ë¹„) - ì†Œìˆ˜ì  ì—†ìŒ
  sheet.getRange(`E${row}:F${row}`).setNumberFormat('0%');
}

/**
 * ì‚¬ë£Œ í‘œ ì „ì²´ ì„œì‹ ì ìš©
 */
function applyFeedTableFormats(summarySheet) {
  console.log('ì‚¬ë£Œ í‘œ ì„œì‹ ì ìš©');
  
  // C5:C15 (ë‹¨ê°€): ì²œ ë‹¨ìœ„ ì½¤ë§ˆ
  summarySheet.getRange('C5:C15').setNumberFormat('#,##0');
  
  // D5:D15 (êµ¬ì…ëŸ‰): ì²œ ë‹¨ìœ„ ì½¤ë§ˆ
  summarySheet.getRange('D5:D15').setNumberFormat('#,##0');
  
  // E5:E15 (êµ¬ì…ê¸ˆì•¡): ì²œ ë‹¨ìœ„ ì½¤ë§ˆ
  summarySheet.getRange('E5:E15').setNumberFormat('#,##0');
  
  // D16, E16 (í•©ê³„): ì²œ ë‹¨ìœ„ ì½¤ë§ˆ + êµµê²Œ í‘œì‹œ
  summarySheet.getRange('D16').setNumberFormat('#,##0').setFontWeight('bold');
  summarySheet.getRange('E16').setNumberFormat('#,##0').setFontWeight('bold');
  
  console.log('  ì„œì‹ ì ìš© ì™„ë£Œ: C5:E15 ë° D16, E16 í•©ê³„');
}

// ===============================================
// í—¬í¼ í•¨ìˆ˜ë“¤
// ===============================================

/**
 * ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ ì°¾ê¸°
 */
function findSummarySheet() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const possibleNames = ['ì´ ì •ë¦¬ í‘œ', 'ì´ì •ë¦¬í‘œ', 'ì´ ì •ë¦¬í‘œ', 'ì´ì •ë¦¬ í‘œ'];
  
  for (const name of possibleNames) {
    const sheet = spreadsheet.getSheetByName(name);
    if (sheet) return sheet;
  }
  
  return null;
}

/**
 * ì‚¬ë£Œ ì •ë¦¬ í‘œ ì‹œíŠ¸ ì°¾ê¸°
 */
function findFeedSheet() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const possibleNames = ['ì‚¬ë£Œ ì •ë¦¬ í‘œ', 'ì‚¬ë£Œì •ë¦¬í‘œ', 'ì‚¬ë£Œ ì •ë¦¬í‘œ', 'ì‚¬ë£Œì •ë¦¬ í‘œ'];
  
  for (const name of possibleNames) {
    const sheet = spreadsheet.getSheetByName(name);
    if (sheet) return sheet;
  }
  
  return null;
}

/**
 * ê¸°ì¤€ ë…„ì›” ê°€ì ¸ì˜¤ê¸°
 */
function getBaseYearMonthFromSheet(sheet) {
  const year = sheet.getRange('D1').getValue().toString();
  const month = sheet.getRange('F1').getValue().toString();
  const prevMonth = sheet.getRange('F2').getValue() || (parseInt(month) - 1);
  
  return {
    year: year,
    month: month.padStart(2, '0'),
    yearShort: year.substring(2),
    monthShort: parseInt(month).toString(),
    prevMonth: prevMonth
  };
}

/**
 * í—¤ë” ì¸ë±ìŠ¤ ì°¾ê¸°
 */
function findHeaderIndex(headers, possibleNames) {
  for (let i = 0; i < headers.length; i++) {
    const header = headers[i].toString().trim();
    for (const name of possibleNames) {
      if (header.includes(name)) {
        return i;
      }
    }
  }
  return -1;
}

/**
 * í’ˆëª… ì •ê·œí™”
 */
function normalizeItemName(name) {
  if (!name) return '';
  
  const nameStr = name.toString().trim();
  
  // í’ˆëª… ë§¤í•‘ í…Œì´ë¸”
  const nameMap = {
    'ì†¡ì•„ì§€ë³¸110+': ['ì†¡ì•„ì§€ë³¸110+', 'ì†¡ì•„ì§€ë³¸110', 'ì†¡ì•„ì§€ë³¸ 110+'],
    'ì†¡ì•„ì§€ë³¸230+': ['ì†¡ì•„ì§€ë³¸230+', 'ì†¡ì•„ì§€ë³¸230', 'ì†¡ì•„ì§€ë³¸ 230+'],
    'í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ì§€ëŒ€': ['í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ì§€ëŒ€', 'í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ì§€ëŒ€', 'í¬ì»¤ìŠ¤ ë§ˆë¬´ë¦¬ ì§€ëŒ€'],
    'í¬ì»¤ìŠ¤ìœ¡ì„±(ì•”/ìˆ˜) ì§€ëŒ€': ['í¬ì»¤ìŠ¤ìœ¡ì„±(ì•”/ìˆ˜) ì§€ëŒ€', 'í¬ì»¤ìŠ¤ìœ¡ì„± ì§€ëŒ€', 'í¬ì»¤ìŠ¤ìœ¡ì„±ì§€ëŒ€'],
    'í¬ì»¤ìŠ¤ì„ì‹ ìš° ì§€ëŒ€': ['í¬ì»¤ìŠ¤ì„ì‹ ìš° ì§€ëŒ€', 'í¬ì»¤ìŠ¤ì„ì‹ ìš°ì§€ëŒ€', 'í¬ì»¤ìŠ¤ ì„ì‹ ìš° ì§€ëŒ€'],
    'í¬ì»¤ìŠ¤í°ì†Œ ì§€ëŒ€': ['í¬ì»¤ìŠ¤í°ì†Œ ì§€ëŒ€', 'í¬ì»¤ìŠ¤í°ì†Œì§€ëŒ€', 'í¬ì»¤ìŠ¤ í°ì†Œ ì§€ëŒ€'],
    'í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ë²Œí¬': ['í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ë²Œí¬', 'í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ë²Œí¬', 'í¬ì»¤ìŠ¤ ë§ˆë¬´ë¦¬ ë²Œí¬'],
    'í¬ì»¤ìŠ¤ë²ˆì‹ìš° ë²Œí¬': ['í¬ì»¤ìŠ¤ë²ˆì‹ìš° ë²Œí¬', 'í¬ì»¤ìŠ¤ë²ˆì‹ìš°ë²Œí¬', 'í¬ì»¤ìŠ¤ ë²ˆì‹ìš° ë²Œí¬'],
    'í¬ì»¤ìŠ¤ìœ¡ì„± ë²Œí¬': ['í¬ì»¤ìŠ¤ìœ¡ì„± ë²Œí¬', 'í¬ì»¤ìŠ¤ìœ¡ì„±ë²Œí¬', 'í¬ì»¤ìŠ¤ ìœ¡ì„± ë²Œí¬'],
    'í¬ì»¤ìŠ¤í°ì†Œ ë²Œí¬': ['í¬ì»¤ìŠ¤í°ì†Œ ë²Œí¬', 'í¬ì»¤ìŠ¤í°ì†Œë²Œí¬', 'í¬ì»¤ìŠ¤ í°ì†Œ ë²Œí¬'],
    'ì—°ë§¥': ['ì—°ë§¥', 'ì—° ë§¥']
  };
  
  // ë§¤í•‘ í…Œì´ë¸”ì—ì„œ ì°¾ê¸°
  for (const [standardName, variations] of Object.entries(nameMap)) {
    for (const variation of variations) {
      if (nameStr.includes(variation)) {
        return standardName;
      }
    }
  }
  
  return nameStr;
}

/**
 * ìˆ«ì í¬ë§·íŒ… (ì²œ ë‹¨ìœ„ ì½¤ë§ˆ)
 */
function formatNumber(num) {
  if (typeof num !== 'number') {
    num = parseFloat(num) || 0;
  }
  return num.toLocaleString('ko-KR');
}

// ===============================================
// ë©”ë‰´ ì¶”ê°€ í•¨ìˆ˜ (ì„ íƒì )
// ===============================================

/**
 * ë©”ë‰´ì— ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬ ê¸°ëŠ¥ ì¶”ê°€
 * ë©”ì¸ Code.gsì˜ onOpen í•¨ìˆ˜ì—ì„œ í˜¸ì¶œí•˜ê±°ë‚˜ ë³„ë„ë¡œ ì‹¤í–‰
 */
function addFeedMenuItems() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    // ê¸°ì¡´ ë©”ë‰´ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¶”ê°€
    ui.createMenu('ğŸŒ¾ ì‚¬ë£Œ ë°ì´í„° ì²˜ë¦¬')
      .addItem('ğŸ“Š ì‚¬ë£Œ í‘œ ìë™ ì±„ìš°ê¸°', 'processFeedData')
      .addItem('ğŸ“ˆ ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì ë§Œ ì—…ë°ì´íŠ¸', 'updatePurchaseRecordOnly')
      .addSeparator()
      .addItem('ğŸ‘ï¸ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° (í† ê¸€)', 'toggleEmptyFeedRows')
      .addItem('ğŸ‘ï¸ ëª¨ë“  í–‰ ë³´ì´ê¸°', 'showAllHiddenRows')
      .addSeparator()
      .addItem('ğŸ” í“¨ë¦¬ë‚˜ ë°ì´í„° í™•ì¸', 'checkPurinaData')
      .addItem('ğŸ” ì œì¶•ì„¬ìœ ì§ˆ ë°ì´í„° í™•ì¸', 'checkFiberData')
      .addSeparator()
      .addItem('ğŸ—‘ï¸ ì‚¬ë£Œ í‘œ ì´ˆê¸°í™”', 'clearFeedTableData')
      .addToUi();
      
  } catch (error) {
    console.error('ë©”ë‰´ ì¶”ê°€ ì˜¤ë¥˜:', error);
  }
}

/**
 * êµ¬ë§¤ì‹¤ì ë§Œ ì—…ë°ì´íŠ¸
 */
function updatePurchaseRecordOnly() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    const summarySheet = findSummarySheet();
    if (!summarySheet) {
      ui.alert('ì˜¤ë¥˜', 'ì´ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
      return;
    }
    
    const baseYearMonth = getBaseYearMonthFromSheet(summarySheet);
    const result = updateFeedPurchaseRecord(summarySheet, baseYearMonth);
    
    // ë¹ˆ í–‰ ìë™ ìˆ¨ê¸°ê¸° (êµ¬ë§¤ì‹¤ì  í‘œë§Œ)
    let hiddenCount = 0;
    for (let i = 19; i <= 30; i++) {
      const dValue = summarySheet.getRange(`D${i}`).getValue();
      if (!dValue) {
        summarySheet.hideRows(i);
        hiddenCount++;
      }
    }
    
    ui.alert('ì™„ë£Œ', 
            `${baseYearMonth.month}ì›” êµ¬ë§¤ì‹¤ì  ì—…ë°ì´íŠ¸ ì™„ë£Œ (B18:F30)\n\n` +
            `ê³„íš ëŒ€ë¹„: ${result.executionRate}\n` +
            `ì „ì›” ëŒ€ë¹„: ${result.monthOverMonth}\n` +
            `ìˆ¨ê¸´ ë¹ˆ í–‰: ${hiddenCount}ê°œ`,
            ui.ButtonSet.OK);
            
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', `ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * í“¨ë¦¬ë‚˜ ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)
 */
function checkPurinaData() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    const summarySheet = findSummarySheet();
    const baseYearMonth = getBaseYearMonthFromSheet(summarySheet);
    const data = processPurinaData(baseYearMonth);
    
    let message = `í“¨ë¦¬ë‚˜ ë°ì´í„° (${baseYearMonth.year}ë…„ ${baseYearMonth.month}ì›”)\n\n`;
    
    if (data.items.length === 0) {
      message += 'ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    } else {
      data.items.forEach(item => {
        message += `${item.name}:\n`;
        message += `  ë‹¨ê°€: ${formatNumber(item.unitPrice)}ì›\n`;
        message += `  êµ¬ì…ëŸ‰: ${formatNumber(item.weight)}kg\n`;
        message += `  ê¸ˆì•¡: ${formatNumber(item.amount)}ì›\n\n`;
      });
      message += `ì´ ê¸ˆì•¡: ${formatNumber(data.totalAmount)}ì›`;
    }
    
    ui.alert('í“¨ë¦¬ë‚˜ ë°ì´í„°', message, ui.ButtonSet.OK);
    
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * ì œì¶•ì„¬ìœ ì§ˆ ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)
 */
function checkFiberData() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    const summarySheet = findSummarySheet();
    const baseYearMonth = getBaseYearMonthFromSheet(summarySheet);
    const data = processFiberData(baseYearMonth);
    
    let message = `ì œì¶•ì„¬ìœ ì§ˆì‚¬ë£Œ ë°ì´í„° (${baseYearMonth.year}ë…„ ${baseYearMonth.month}ì›”)\n\n`;
    
    if (data.items.length === 0) {
      message += 'ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    } else {
      data.items.forEach(item => {
        message += `${item.name}:\n`;
        message += `  ë‹¨ê°€: ${formatNumber(item.unitPrice)}ì›\n`;
        message += `  êµ¬ì…ëŸ‰: ${formatNumber(item.weight)}kg\n`;
        message += `  ê¸ˆì•¡: ${formatNumber(item.amount)}ì›\n\n`;
      });
      message += `ì´ ê¸ˆì•¡: ${formatNumber(data.totalAmount)}ì›`;
    }
    
    ui.alert('ì œì¶•ì„¬ìœ ì§ˆ ë°ì´í„°', message, ui.ButtonSet.OK);
    
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * ì‚¬ë£Œ í‘œ ë°ì´í„° ì¼ê´„ ì‚­ì œ (ì´ˆê¸°í™”ìš©)
 */
function clearFeedTableData() {
  const ui = SpreadsheetApp.getUi();
  
  const response = ui.alert(
    'ì‚¬ë£Œ í‘œ ì´ˆê¸°í™”',
    'ì‚¬ë£Œ í‘œì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
    'ì‚­ì œ ë²”ìœ„:\n' +
    'â€¢ ì‚¬ë£Œ í‘œ: C5:E16\n' +
    'â€¢ êµ¬ë§¤ì‹¤ì  í‘œ: C19:F30 (ì„ íƒì )',
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    try {
      const summarySheet = findSummarySheet();
      if (!summarySheet) {
        ui.alert('ì˜¤ë¥˜', 'ì´ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
        return;
      }
      
      // ìˆ¨ê²¨ì§„ í–‰ ëª¨ë‘ í‘œì‹œ (ì´ˆê¸°í™” ì „ì—)
      summarySheet.showRows(5, 11);  // ì‚¬ë£Œ í‘œ
      summarySheet.showRows(19, 12); // êµ¬ë§¤ì‹¤ì  í‘œ
      
      // ì‚¬ë£Œ í‘œ ë°ì´í„° ì´ˆê¸°í™” (C5:E16)
      summarySheet.getRange('C5:E16').clearContent();
      
      // êµ¬ë§¤ì‹¤ì  í‘œë„ ì´ˆê¸°í™”í• ì§€ ë¬»ê¸°
      const clearPurchaseResponse = ui.alert(
        'ì¶”ê°€ ì´ˆê¸°í™”',
        'ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ(C19:F30)ë„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        ui.ButtonSet.YES_NO
      );
      
      if (clearPurchaseResponse === ui.Button.YES) {
        summarySheet.getRange('C19:F30').clearContent();
        ui.alert('ì™„ë£Œ', 'ì‚¬ë£Œ í‘œì™€ êµ¬ë§¤ì‹¤ì  í‘œê°€ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nìˆ¨ê²¨ì§„ í–‰ë„ ëª¨ë‘ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
      } else {
        ui.alert('ì™„ë£Œ', 'ì‚¬ë£Œ í‘œ ë°ì´í„°ë§Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nìˆ¨ê²¨ì§„ í–‰ë„ ëª¨ë‘ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
      }
      
      console.log('ì‚¬ë£Œ í‘œ ì´ˆê¸°í™” ì™„ë£Œ');
      
    } catch (error) {
      ui.alert('ì˜¤ë¥˜', `ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ${error.toString()}`, ui.ButtonSet.OK);
    }
  }
}

/**
 * ìë™ìœ¼ë¡œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° (ë°ì´í„° ì²˜ë¦¬ í›„ ìë™ ì‹¤í–‰)
 */
function autoHideEmptyRows(summarySheet) {
  console.log('ë¹ˆ í–‰ ìë™ ìˆ¨ê¸°ê¸° ì‹œì‘');
  
  const result = {
    feedTableHidden: 0,
    purchaseTableHidden: 0
  };
  
  try {
    // 1. ì‚¬ë£Œ í‘œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° (B4:F16)
    // Dì—´(êµ¬ì…ëŸ‰)ê³¼ Eì—´(êµ¬ì…ê¸ˆì•¡)ì´ ëª¨ë‘ ë¹„ì–´ìˆëŠ” í–‰ ìˆ¨ê¸°ê¸°
    for (let i = 5; i <= 15; i++) {
      const dValue = summarySheet.getRange(`D${i}`).getValue(); // êµ¬ì…ëŸ‰
      const eValue = summarySheet.getRange(`E${i}`).getValue(); // êµ¬ì…ê¸ˆì•¡
      
      if (!dValue && !eValue) {
        summarySheet.hideRows(i);
        result.feedTableHidden++;
        console.log(`  ì‚¬ë£Œ í‘œ ${i}í–‰ ìˆ¨ê¹€`);
      }
    }
    
    // 2. ì‚¬ë£Œ êµ¬ë§¤ì‹¤ì  í‘œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° (B18:F30)
    // Dì—´(êµ¬ë§¤ì‹¤ì )ì´ ë¹„ì–´ìˆëŠ” í–‰ ìˆ¨ê¸°ê¸°
    for (let i = 19; i <= 30; i++) {
      const dValue = summarySheet.getRange(`D${i}`).getValue(); // êµ¬ë§¤ì‹¤ì 
      
      if (!dValue) {
        summarySheet.hideRows(i);
        result.purchaseTableHidden++;
        console.log(`  êµ¬ë§¤ì‹¤ì  í‘œ ${i}í–‰ ìˆ¨ê¹€`);
      }
    }
    
    console.log(`ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° ì™„ë£Œ: ì‚¬ë£Œ í‘œ ${result.feedTableHidden}ê°œ, êµ¬ë§¤ì‹¤ì  í‘œ ${result.purchaseTableHidden}ê°œ`);
    return result;
    
  } catch (error) {
    console.error('ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° ì˜¤ë¥˜:', error);
    return result;
  }
}

/**
 * ì‚¬ë£Œ í‘œì™€ êµ¬ë§¤ì‹¤ì  í‘œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° í† ê¸€
 */
function toggleEmptyFeedRows() {
  const summarySheet = findSummarySheet();
  const ui = SpreadsheetApp.getUi();
  
  if (!summarySheet) {
    ui.alert('ì˜¤ë¥˜', 'ì´ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    return;
  }
  
  // í˜„ì¬ ìˆ¨ê²¨ì§„ í–‰ì´ ìˆëŠ”ì§€ í™•ì¸
  let hasHiddenRows = false;
  
  // ì‚¬ë£Œ í‘œ ë²”ìœ„ í™•ì¸ (5-15í–‰)
  for (let i = 5; i <= 15; i++) {
    if (summarySheet.isRowHiddenByUser(i)) {
      hasHiddenRows = true;
      break;
    }
  }
  
  // êµ¬ë§¤ì‹¤ì  í‘œ ë²”ìœ„ í™•ì¸ (19-30í–‰)
  if (!hasHiddenRows) {
    for (let i = 19; i <= 30; i++) {
      if (summarySheet.isRowHiddenByUser(i)) {
        hasHiddenRows = true;
        break;
      }
    }
  }
  
  if (hasHiddenRows) {
    // ìˆ¨ê²¨ì§„ í–‰ì´ ìˆìœ¼ë©´ ëª¨ë‘ ë³´ì´ê¸°
    summarySheet.showRows(5, 11);  // ì‚¬ë£Œ í‘œ (5í–‰ë¶€í„° 11ê°œ í–‰)
    summarySheet.showRows(19, 12); // êµ¬ë§¤ì‹¤ì  í‘œ (19í–‰ë¶€í„° 12ê°œ í–‰)
    ui.alert('ì™„ë£Œ', 'ëª¨ë“  í–‰ì„ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    console.log('ëª¨ë“  í–‰ í‘œì‹œ ì™„ë£Œ');
    
  } else {
    // ë¹ˆ í–‰ ìˆ¨ê¸°ê¸°
    const result = autoHideEmptyRows(summarySheet);
    
    if (result.feedTableHidden > 0 || result.purchaseTableHidden > 0) {
      ui.alert('ì™„ë£Œ', 
              `ë¹ˆ í–‰ ìˆ¨ê¸°ê¸° ì™„ë£Œ:\n\n` +
              `â€¢ ì‚¬ë£Œ í‘œ: ${result.feedTableHidden}ê°œ í–‰\n` +
              `â€¢ êµ¬ë§¤ì‹¤ì  í‘œ: ${result.purchaseTableHidden}ê°œ í–‰`,
              ui.ButtonSet.OK);
    } else {
      ui.alert('ì •ë³´', 'ìˆ¨ê¸¸ ë¹ˆ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    }
  }
}

/**
 * ëª¨ë“  ìˆ¨ê²¨ì§„ í–‰ ë³´ì´ê¸°
 */
function showAllHiddenRows() {
  const summarySheet = findSummarySheet();
  const ui = SpreadsheetApp.getUi();
  
  if (!summarySheet) {
    ui.alert('ì˜¤ë¥˜', 'ì´ ì •ë¦¬ í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    return;
  }
  
  // ì‚¬ë£Œ í‘œì™€ êµ¬ë§¤ì‹¤ì  í‘œì˜ ëª¨ë“  í–‰ ë³´ì´ê¸°
  summarySheet.showRows(5, 11);  // ì‚¬ë£Œ í‘œ (5-15í–‰)
  summarySheet.showRows(19, 12); // êµ¬ë§¤ì‹¤ì  í‘œ (19-30í–‰)
  
  ui.alert('ì™„ë£Œ', 'ëª¨ë“  ìˆ¨ê²¨ì§„ í–‰ì„ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
  console.log('ëª¨ë“  í–‰ í‘œì‹œ ì™„ë£Œ');
}
