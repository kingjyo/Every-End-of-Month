/**
 * ê±°ë˜ì²˜ì›ì¥ ë°ì´í„° ì •ë¦¬ ëª¨ë“ˆ v3.1
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ìë™ íƒì§€
 * 2. ê³µê¸‰ê°€ì•¡ ê³„ì‚° 
 *    - ì¼ë°˜: ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
 *    - ê³¼ì„¸: ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€ Ã· 1.1)
 * 3. ì”ì•¡ ëˆ„ì  ê³„ì‚°
 * 4. í’ˆëª…/ì ìš” í‘œì¤€í™”
 * 5. í•©ê³„ ìë™ ì¶”ê°€
 * 
 * ì´ ëª¨ë“ˆì€ ë°ì´í„°ë§Œ ì •ë¦¬í•˜ë©°, ì‹œíŠ¸ ì‚­ì œë‚˜ ê´€ë¦¬ëŠ” í•˜ì§€ ì•ŠìŒ
 */

/**
 * ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ë©”ì¸ í•¨ìˆ˜
 */
function processSupplierLedgers() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    logDebug('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬', 'ì‹œì‘');
    
    // ê¸°ì¤€ ë…„/ì›” ê°€ì ¸ì˜¤ê¸°
    const baseDate = getBaseYearMonth();
    
    // ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì°¾ê¸°
    const ledgerSheets = findLedgerSheets(baseDate);
    
    if (ledgerSheets.length === 0) {
      ui.alert(
        'ì‹œíŠ¸ ì—†ìŒ',
        'ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        ui.ButtonSet.OK
      );
      return;
    }
    
    // ì²˜ë¦¬ í™•ì¸
    const response = ui.alert(
      'ğŸ’¼ ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬',
      `${ledgerSheets.length}ê°œì˜ ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:\n\n` +
      `${ledgerSheets.map(s => 'â€¢ ' + s.getName()).join('\n')}\n\n` +
      `ì‘ì—… ë‚´ìš©:\n` +
      `â€¢ ê³µê¸‰ê°€ì•¡ ìë™ ê³„ì‚°\n` +
      `  - ì¼ë°˜/ì˜ì„¸: ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n` +
      `  - ê³¼ì„¸: ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€ Ã· 1.1)\n` +
      `â€¢ ë¶€ê°€ì„¸ = ê³µê¸‰ê°€ì•¡ Ã— 10% ê³„ì‚°\n` +
      `â€¢ í’ˆëª…/ì ìš” í‘œì¤€í™”\n` +
      `â€¢ ì”ì•¡ ëˆ„ì  ê³„ì‚°\n\n` +
      `ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    // ê° ì‹œíŠ¸ ì²˜ë¦¬
    const results = [];
    let totalProcessed = 0;
    let totalAmount = 0;
    
    ledgerSheets.forEach(sheet => {
      try {
        const result = processLedgerSheet(sheet);
        results.push(result);
        totalProcessed += result.processedRows;
        totalAmount += result.totalAmount;
        
        logDebug('ì‹œíŠ¸ ì²˜ë¦¬ ì™„ë£Œ', 
                 `${sheet.getName()}: ${result.processedRows}í–‰, ${formatAmount(result.totalAmount)}ì›`);
        
      } catch (error) {
        results.push({
          sheetName: sheet.getName(),
          success: false,
          error: error.toString()
        });
        logDebug('ì‹œíŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜', `${sheet.getName()}: ${error.toString()}`);
      }
    });
    
    // ê²°ê³¼ í‘œì‹œ
    showResults(results, totalProcessed, totalAmount);
    
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', `ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`, ui.ButtonSet.OK);
    logDebug('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì˜¤ë¥˜', error.toString());
  }
}

/**
 * ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì°¾ê¸°
 */
function findLedgerSheets(baseDate) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  const ledgerSheets = [];
  
  // ì°¾ì„ íŒ¨í„´ë“¤
  const patterns = [
    `ê±°ë˜ì²˜ì›ì¥${baseDate.yearShort}.${baseDate.month}`,
    `ê±°ë˜ì²˜ì›ì¥${baseDate.yearShort}.${baseDate.monthShort}`,
    `ê±°ë˜ì²˜ì›ì¥ ${baseDate.yearShort}.${baseDate.month}`,
    `ê±°ë˜ì²˜ì›ì¥ ${baseDate.yearShort}.${baseDate.monthShort}`,
    `ê±°ë˜ì²˜ ì›ì¥${baseDate.yearShort}`,
    `ê±°ë˜ì²˜ì›ì¥`
  ];
  
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const sheetNameLower = sheetName.toLowerCase();
    
    // ë³´í˜¸ ì‹œíŠ¸ëŠ” ì œì™¸ (ì´ ì •ë¦¬ í‘œ ë“±)
    if (sheetNameLower.includes('ì •ë¦¬') || sheetNameLower.includes('ì •ë¦¬í‘œ')) {
      return;
    }
    
    // ê±°ë˜ì²˜ì›ì¥ íŒ¨í„´ í™•ì¸
    const isLedger = patterns.some(pattern => 
      sheetNameLower.includes(pattern.toLowerCase())
    ) || sheetNameLower.includes('ì›ì¥');
    
    if (isLedger) {
      // ë°ì´í„° êµ¬ì¡° í™•ì¸
      if (hasLedgerStructure(sheet)) {
        ledgerSheets.push(sheet);
        logDebug('ê±°ë˜ì²˜ì›ì¥ ë°œê²¬', sheetName);
      }
    }
  });
  
  return ledgerSheets;
}

/**
 * ê±°ë˜ì²˜ì›ì¥ êµ¬ì¡°ì¸ì§€ í™•ì¸
 */
function hasLedgerStructure(sheet) {
  try {
    const data = sheet.getDataRange().getValues();
    
    // ì²˜ìŒ 20í–‰ì—ì„œ "ê±°ë˜ì²˜ ì›ì¥" í…ìŠ¤íŠ¸ ì°¾ê¸°
    for (let i = 0; i < Math.min(20, data.length); i++) {
      for (let j = 0; j < Math.min(5, data[i].length); j++) {
        const cellValue = String(data[i][j]).toLowerCase();
        if (cellValue.includes('ê±°ë˜ì²˜') && cellValue.includes('ì›ì¥')) {
          return true;
        }
      }
    }
    
    // ë˜ëŠ” í—¤ë” í‚¤ì›Œë“œë¡œ íŒë‹¨
    const headerKeywords = ['ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'ê³µê¸‰ê°€', 'ê¸ˆì•¡', 'í’ˆëª…'];
    let keywordCount = 0;
    
    for (let i = 0; i < Math.min(15, data.length); i++) {
      const rowText = data[i].join(' ').toLowerCase();
      headerKeywords.forEach(keyword => {
        if (rowText.includes(keyword)) keywordCount++;
      });
      
      if (keywordCount >= 3) return true;
    }
    
    return false;
    
  } catch (error) {
    return false;
  }
}

/**
 * ê°œë³„ ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì²˜ë¦¬
 */
function processLedgerSheet(sheet) {
  const sheetName = sheet.getName();
  
  // ì‹œíŠ¸ íƒ€ì… íŒë³„
  const sheetType = detectSheetType(sheetName);
  const isTaxable = sheetType === 'ì•½í’ˆ_ê³¼ì„¸'; // ê³¼ì„¸ ì‹œíŠ¸ ì—¬ë¶€
  
  logDebug('ì‹œíŠ¸ íƒ€ì…', `${sheetName}: ${sheetType} (ê³¼ì„¸: ${isTaxable})`);
  
  // ë°ì´í„° ì˜ì—­ ì°¾ê¸°
  const dataInfo = findDataRange(sheet);
  if (!dataInfo) {
    throw new Error('ë°ì´í„° ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  // í—¤ë” ì •ë³´ ë¶„ì„
  const headerInfo = analyzeHeaders(sheet, dataInfo.headerRow);
  if (!headerInfo.valid) {
    throw new Error('í•„ìˆ˜ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  // ë°ì´í„° ì²˜ë¦¬
  let processedRows = 0;
  let totalAmount = 0;
  let runningBalance = 0;
  
  // ê° ë°ì´í„° í–‰ ì²˜ë¦¬
  for (let row = dataInfo.startRow; row <= dataInfo.endRow; row++) {
    try {
      // í–‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const rowData = sheet.getRange(row, 1, 1, sheet.getMaxColumns()).getValues()[0];
      
      // ë¹ˆ í–‰ ì²´í¬
      if (isEmptyRow(rowData, headerInfo.columns)) {
        continue;
      }
      
      // ìˆ˜ëŸ‰, ë‹¨ê°€ ê°€ì ¸ì˜¤ê¸°
      const quantity = parseNumber(rowData[headerInfo.columns.quantity]);
      let unitPrice = parseNumber(rowData[headerInfo.columns.unitPrice]);
      
      // ì¤‘ëŸ‰ì´ ìˆëŠ” ê²½ìš° (Dì—´)
      let weight = 1;
      if (headerInfo.columns.weight !== undefined) {
        weight = parseNumber(rowData[headerInfo.columns.weight]) || 1;
      }
      
      // ê³µê¸‰ê°€ì•¡ ê³„ì‚°
      let supplyAmount = 0;
      
      if (isTaxable) {
        // ê³¼ì„¸ ì‹œíŠ¸: ë‹¨ê°€ì— ë¶€ê°€ì„¸ í¬í•¨ë˜ì–´ ìˆìŒ
        // ê³µê¸‰ê°€ì•¡ = ì¤‘ëŸ‰ Ã— ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€ Ã· 1.1)
        const priceWithoutVAT = unitPrice / 1.1; // ë¶€ê°€ì„¸ ì œì™¸ ë‹¨ê°€
        const roundedPrice = Math.round(priceWithoutVAT * 10000) / 10000; // ì†Œìˆ˜ì  4ìë¦¬
        supplyAmount = Math.round(weight * quantity * roundedPrice);
        
        logDebug('ê³¼ì„¸ ê³„ì‚°', 
                 `í–‰ ${row}: ë‹¨ê°€ ${unitPrice} â†’ VATì œì™¸ ${roundedPrice} Ã— ìˆ˜ëŸ‰ ${quantity} = ${supplyAmount}`);
        
      } else {
        // ì¼ë°˜/ì˜ì„¸ ì‹œíŠ¸: ë‹¨ê°€ì— ë¶€ê°€ì„¸ ë¯¸í¬í•¨
        // ê³µê¸‰ê°€ì•¡ = ì¤‘ëŸ‰ Ã— ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
        supplyAmount = Math.round(weight * quantity * unitPrice);
      }
      
      if (supplyAmount > 0) {
        // ê³µê¸‰ê°€ì•¡ ì„¤ì •
        sheet.getRange(row, headerInfo.columns.supplyAmount + 1).setValue(supplyAmount);
        sheet.getRange(row, headerInfo.columns.supplyAmount + 1).setNumberFormat('#,##0');
        
        // ë¶€ê°€ì„¸ ê³„ì‚° (ìˆëŠ” ê²½ìš°)
        if (headerInfo.columns.vat !== undefined) {
          let vat = 0;
          
          if (isTaxable) {
            // ê³¼ì„¸: ë¶€ê°€ì„¸ ë³„ë„ ê³„ì‚° (ê³µê¸‰ê°€ì•¡ì˜ 10%)
            vat = Math.round(supplyAmount * 0.1);
          } else if (sheetType === 'ì•½í’ˆ_ì˜ì„¸') {
            // ì˜ì„¸: ë¶€ê°€ì„¸ 0
            vat = 0;
          } else {
            // ê¸°íƒ€: ê³µê¸‰ê°€ì•¡ì˜ 10%
            vat = Math.round(supplyAmount * 0.1);
          }
          
          sheet.getRange(row, headerInfo.columns.vat + 1).setValue(vat);
          sheet.getRange(row, headerInfo.columns.vat + 1).setNumberFormat('#,##0');
        }
        
        // í•©ê³„ (ìˆëŠ” ê²½ìš°)
        if (headerInfo.columns.total !== undefined) {
          const vat = headerInfo.columns.vat !== undefined ? 
                      parseNumber(sheet.getRange(row, headerInfo.columns.vat + 1).getValue()) : 0;
          const total = supplyAmount + vat;
          
          sheet.getRange(row, headerInfo.columns.total + 1).setValue(total);
          sheet.getRange(row, headerInfo.columns.total + 1).setNumberFormat('#,##0');
        }
        
        // ì”ì•¡ ëˆ„ì 
        runningBalance += supplyAmount;
        if (headerInfo.columns.balance !== undefined) {
          sheet.getRange(row, headerInfo.columns.balance + 1).setValue(runningBalance);
          sheet.getRange(row, headerInfo.columns.balance + 1).setNumberFormat('#,##0');
        }
        
        totalAmount += supplyAmount;
        processedRows++;
      }
      
      // í’ˆëª… í‘œì¤€í™”
      if (headerInfo.columns.description !== undefined) {
        const originalName = rowData[headerInfo.columns.description];
        const standardName = standardizeItemName(originalName, sheetType);
        if (standardName !== originalName) {
          sheet.getRange(row, headerInfo.columns.description + 1).setValue(standardName);
        }
      }
      
    } catch (error) {
      logDebug('í–‰ ì²˜ë¦¬ ì˜¤ë¥˜', `${sheetName} ${row}í–‰: ${error.toString()}`);
    }
  }
  
  // í•©ê³„ í–‰ ì¶”ê°€
  if (totalAmount > 0 && dataInfo.endRow < sheet.getMaxRows()) {
    addTotalRow(sheet, dataInfo.endRow + 1, headerInfo.columns, totalAmount, isTaxable);
  }
  
  return {
    sheetName: sheetName,
    sheetType: sheetType,
    isTaxable: isTaxable,
    success: true,
    processedRows: processedRows,
    totalAmount: totalAmount,
    dataRange: `${dataInfo.startRow}~${dataInfo.endRow}í–‰`
  };
}

/**
 * ì‹œíŠ¸ íƒ€ì… íŒë³„
 */
function detectSheetType(sheetName) {
  const nameLower = sheetName.toLowerCase();
  
  // ê³¼ì„¸ í™•ì¸ì´ ìµœìš°ì„ 
  if (nameLower.includes('ê³¼ì„¸')) {
    return 'ì•½í’ˆ_ê³¼ì„¸';
  }
  
  // ì˜ì„¸ í™•ì¸
  if (nameLower.includes('ì˜ì„¸')) {
    return 'ì•½í’ˆ_ì˜ì„¸';
  }
  
  // ê¸°íƒ€ íƒ€ì…
  if (nameLower.includes('í“¨ë¦¬ë‚˜')) return 'ì‚¬ë£Œ';
  if (nameLower.includes('ì œì¶•ì„¬ìœ ì§ˆ')) return 'ì—°ë§¥';
  if (nameLower.includes('í˜„í´ë¦¬ë‹‰')) return 'ì•½í’ˆ';
  
  return 'ê¸°íƒ€';
}

/**
 * ë°ì´í„° ì˜ì—­ ì°¾ê¸°
 */
function findDataRange(sheet) {
  const maxRows = sheet.getMaxRows();
  
  // Bì—´ì—ì„œ "ê±°ë˜ì²˜ ì›ì¥" ì°¾ê¸°
  for (let row = 1; row <= Math.min(30, maxRows); row++) {
    const cellValue = sheet.getRange(row, 2).getValue();
    
    if (cellValue && String(cellValue).includes('ê±°ë˜ì²˜')) {
      // í—¤ë”ëŠ” ë³´í†µ 5í–‰ ì•„ë˜
      const headerRow = row + 5;
      
      if (headerRow > maxRows) continue;
      
      // í—¤ë” í™•ì¸
      const headerRange = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns());
      const headers = headerRange.getValues()[0];
      const headerText = headers.join(' ').toLowerCase();
      
      if (headerText.includes('ë‚ ì§œ') || headerText.includes('í’ˆëª…') || headerText.includes('ìˆ˜ëŸ‰')) {
        // ë°ì´í„° ì‹œì‘ê³¼ ë ì°¾ê¸°
        const dataStartRow = headerRow + 1;
        let dataEndRow = dataStartRow;
        
        for (let checkRow = dataStartRow; checkRow <= maxRows; checkRow++) {
          const rowData = sheet.getRange(checkRow, 2, 1, 5).getValues()[0];
          const hasData = rowData.some(cell => cell !== '' && cell !== null);
          
          if (!hasData) {
            // ì—°ì† 2ê°œ ë¹ˆ í–‰ì´ë©´ ì¢…ë£Œ
            if (checkRow + 1 <= maxRows) {
              const nextRowData = sheet.getRange(checkRow + 1, 2, 1, 5).getValues()[0];
              if (!nextRowData.some(cell => cell !== '' && cell !== null)) {
                dataEndRow = checkRow - 1;
                break;
              }
            }
          } else {
            dataEndRow = checkRow;
          }
        }
        
        return {
          headerRow: headerRow,
          startRow: dataStartRow,
          endRow: dataEndRow
        };
      }
    }
  }
  
  return null;
}

/**
 * í—¤ë” ë¶„ì„
 */
function analyzeHeaders(sheet, headerRow) {
  const headers = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns()).getValues()[0];
  const columns = {};
  
  // ê° í—¤ë” ì°¾ê¸° (0-based index)
  headers.forEach((header, index) => {
    const h = String(header).toLowerCase().replace(/\s/g, '');
    
    if (h.includes('ë‚ ì§œ') || h.includes('ì¼ì')) columns.date = index;
    if (h.includes('í’ˆëª…') || h.includes('ì ìš”')) columns.description = index;
    if (h.includes('ì¤‘ëŸ‰') || h === 'ì¤‘') columns.weight = index;
    if ((h === 'ìˆ˜ëŸ‰' || h === 'ìˆ˜' || h.includes('ìˆ˜ëŸ‰')) && !h.includes('ë‹¨')) columns.quantity = index;
    if (h.includes('ë‹¨ê°€') || h === 'ë‹¨') columns.unitPrice = index;
    if (h.includes('ê³µê¸‰ê°€') || h === 'ê³µê¸‰ì•¡' || h === 'ê¸ˆì•¡') columns.supplyAmount = index;
    if (h.includes('ë¶€ê°€ì„¸') || h.includes('ì„¸ì•¡')) columns.vat = index;
    if (h === 'í•©ê³„' || h === 'ì´ì•¡' || h.includes('í•©ê³„')) columns.total = index;
    if (h.includes('ì”ì•¡') || h.includes('ì”ê³ ')) columns.balance = index;
  });
  
  // í•„ìˆ˜ ì—´ í™•ì¸
  const valid = columns.quantity !== undefined && 
                columns.unitPrice !== undefined && 
                columns.supplyAmount !== undefined;
  
  logDebug('í—¤ë” ë¶„ì„', `ìˆ˜ëŸ‰:${columns.quantity}, ë‹¨ê°€:${columns.unitPrice}, ê³µê¸‰ê°€:${columns.supplyAmount}`);
  
  return { valid, columns };
}

/**
 * ë¹ˆ í–‰ í™•ì¸
 */
function isEmptyRow(rowData, columns) {
  // ë‚ ì§œ, í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ í–‰
  const hasDate = columns.date !== undefined && rowData[columns.date];
  const hasDesc = columns.description !== undefined && rowData[columns.description];
  const hasQty = columns.quantity !== undefined && parseNumber(rowData[columns.quantity]) > 0;
  const hasPrice = columns.unitPrice !== undefined && parseNumber(rowData[columns.unitPrice]) > 0;
  
  return !hasDate && !hasDesc && !hasQty && !hasPrice;
}

/**
 * ìˆ«ì íŒŒì‹±
 */
function parseNumber(value) {
  if (typeof value === 'number') return value;
  if (!value) return 0;
  
  let str = String(value);
  str = str.replace(/[,\sì›â‚©$]/g, '');
  
  if (str.startsWith('(') && str.endsWith(')')) {
    str = '-' + str.slice(1, -1);
  }
  
  const num = parseFloat(str);
  return isNaN(num) ? 0 : num;
}

/**
 * í’ˆëª… í‘œì¤€í™”
 */
function standardizeItemName(name, sheetType) {
  if (!name) return '';
  
  let standardized = String(name).trim();
  
  switch(sheetType) {
    case 'ì‚¬ë£Œ':
      return standardizeFeedName(standardized);
    case 'ì•½í’ˆ_ì˜ì„¸':
    case 'ì•½í’ˆ_ê³¼ì„¸':
    case 'ì•½í’ˆ':
      return standardizeMedicineName(standardized);
    case 'ì—°ë§¥':
      return 'ì—°ë§¥';
    default:
      return standardized;
  }
}

/**
 * ì‚¬ë£Œëª… í‘œì¤€í™”
 */
function standardizeFeedName(name) {
  // (í“¨) ì œê±°
  name = name.replace(/[ï¼ˆ(]í“¨[)ï¼‰]/g, '');
  
  // ì†¡ì•„ì§€ë³¸ ì²˜ë¦¬
  if (name.includes('ì†¡ì•„ì§€ë³¸')) {
    if (name.includes('110')) return 'ì†¡ì•„ì§€ë³¸ 110+';
    if (name.includes('230')) return 'ì†¡ì•„ì§€ë³¸ 230+';
  }
  
  // í¬ì»¤ìŠ¤ ì œí’ˆ
  if (name.includes('í¬ì»¤ìŠ¤')) {
    const isBulk = name.includes('ë²Œí¬');
    
    if (name.includes('ë§ˆë¬´ë¦¬')) return `í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('ìœ¡ì„±')) {
      if (name.includes('ì•”/ìˆ˜') || name.includes('ì•”ìˆ˜')) {
        return `í¬ì»¤ìŠ¤ìœ¡ì„±(ì•”/ìˆ˜) ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
      }
      return `í¬ì»¤ìŠ¤ìœ¡ì„± ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    }
    if (name.includes('ì„ì‹ ìš°')) return `í¬ì»¤ìŠ¤ì„ì‹ ìš° ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('í°ì†Œ')) return `í¬ì»¤ìŠ¤í°ì†Œ ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('ë²ˆì‹ìš°')) return `í¬ì»¤ìŠ¤ë²ˆì‹ìš° ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
  }
  
  return name;
}

/**
 * ì•½í’ˆëª… í‘œì¤€í™”
 */
function standardizeMedicineName(name) {
  // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤
  if (name.includes('í”Œë¡œë¦¬ë¶€ìŠ¤í„°-ê°ˆí”„')) return name;
  
  // ë¹„ì˜¤ì“°ë¦¬ íŠ¹ìˆ˜ ì²˜ë¦¬
  if (name.includes('ë¹„ì˜¤ì“°ë¦¬') && name.includes('(ë™-ì‚¼ì–‘)')) {
    return name.replace(/\(ë™-ì‚¼ì–‘\)(\d+[a-zA-Z]+)/g, '(ë™-ì‚¼ì–‘)-$1');
  }
  
  // ì¼ë°˜ì ì¸ ê²½ìš°: ì•½í’ˆëª…-ê·œê²©
  const pattern = /^([^-\d]+)(\d+[a-zA-Z]+)$/;
  const match = name.match(pattern);
  
  if (match) {
    return match[1] + '-' + match[2];
  }
  
  return name;
}

/**
 * í•©ê³„ í–‰ ì¶”ê°€
 */
function addTotalRow(sheet, row, columns, totalAmount, isTaxable) {
  try {
    // "í•©ê³„" í‘œì‹œ
    if (columns.description !== undefined) {
      sheet.getRange(row, columns.description + 1).setValue('í•©ê³„');
    } else if (columns.date !== undefined) {
      sheet.getRange(row, columns.date + 1).setValue('í•©ê³„');
    }
    
    // ì´ì•¡ í‘œì‹œ
    sheet.getRange(row, columns.supplyAmount + 1).setValue(totalAmount);
    sheet.getRange(row, columns.supplyAmount + 1).setNumberFormat('#,##0');
    
    // ë¶€ê°€ì„¸ í•©ê³„ (ê³¼ì„¸ì¸ ê²½ìš°ë§Œ)
    if (columns.vat !== undefined && isTaxable) {
      const totalVat = Math.round(totalAmount * 0.1);
      sheet.getRange(row, columns.vat + 1).setValue(totalVat);
      sheet.getRange(row, columns.vat + 1).setNumberFormat('#,##0');
      
      // ì „ì²´ í•©ê³„ (ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸)
      if (columns.total !== undefined) {
        sheet.getRange(row, columns.total + 1).setValue(totalAmount + totalVat);
        sheet.getRange(row, columns.total + 1).setNumberFormat('#,##0');
      }
    }
    
    // ì„œì‹ ì„¤ì •
    sheet.getRange(row, 1, 1, sheet.getMaxColumns()).setFontWeight('bold');
    sheet.getRange(row, 1, 1, sheet.getMaxColumns()).setBackground('#f0f0f0');
    
    logDebug('í•©ê³„ ì¶”ê°€', `${row}í–‰ì— ${formatAmount(totalAmount)}ì› (ê³¼ì„¸: ${isTaxable})`);
    
  } catch (error) {
    logDebug('í•©ê³„ ì¶”ê°€ ì˜¤ë¥˜', error.toString());
  }
}

/**
 * ì²˜ë¦¬ ê²°ê³¼ í‘œì‹œ
 */
function showResults(results, totalProcessed, totalAmount) {
  const ui = SpreadsheetApp.getUi();
  
  let message = 'ğŸ“Š ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì™„ë£Œ\n\n';
  
  const successResults = results.filter(r => r.success);
  const failedResults = results.filter(r => !r.success);
  
  if (successResults.length > 0) {
    message += 'âœ… ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ ì‹œíŠ¸:\n';
    successResults.forEach(result => {
      message += `\nğŸ“‹ ${result.sheetName} (${result.sheetType})\n`;
      if (result.isTaxable) {
        message += `  â€¢ âš ï¸ ê³¼ì„¸ ì‹œíŠ¸ (ë‹¨ê°€Ã·1.1 ì ìš©)\n`;
      }
      message += `  â€¢ ì²˜ë¦¬ ë²”ìœ„: ${result.dataRange}\n`;
      message += `  â€¢ ì²˜ë¦¬ëœ í–‰: ${result.processedRows}ê°œ\n`;
      message += `  â€¢ ê¸ˆì•¡ í•©ê³„: ${formatAmount(result.totalAmount)}ì›\n`;
    });
  }
  
  if (failedResults.length > 0) {
    message += '\nâš ï¸ ì²˜ë¦¬ ì‹¤íŒ¨:\n';
    failedResults.forEach(result => {
      message += `  â€¢ ${result.sheetName}: ${result.error}\n`;
    });
  }
  
  message += `\nğŸ“Œ ì „ì²´ ìš”ì•½:\n`;
  message += `  â€¢ ì²˜ë¦¬ëœ í–‰: ${totalProcessed}ê°œ\n`;
  message += `  â€¢ ì´ ê¸ˆì•¡: ${formatAmount(totalAmount)}ì›`;
  
  ui.alert('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì™„ë£Œ', message, ui.ButtonSet.OK);
}

/**
 * ê¸ˆì•¡ í¬ë§·íŒ…
 */
function formatAmount(amount) {
  return Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

/**
 * ê±°ë˜ì²˜ì›ì¥ ë¶„ì„ (í…ŒìŠ¤íŠ¸ìš©)
 */
function analyzeSupplierLedgers() {
  const ui = SpreadsheetApp.getUi();
  const baseDate = getBaseYearMonth();
  const ledgerSheets = findLedgerSheets(baseDate);
  
  if (ledgerSheets.length === 0) {
    ui.alert('ë¶„ì„ ê²°ê³¼', 'ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    return;
  }
  
  let report = 'ğŸ“Š ê±°ë˜ì²˜ì›ì¥ ë¶„ì„ ë³´ê³ ì„œ\n';
  report += `ê¸°ì¤€: ${baseDate.year}ë…„ ${baseDate.month}ì›”\n\n`;
  
  ledgerSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const sheetType = detectSheetType(sheetName);
    const isTaxable = sheetType === 'ì•½í’ˆ_ê³¼ì„¸';
    
    report += `\nğŸ“‹ ${sheetName}\n`;
    report += `  ğŸ“Œ íƒ€ì…: ${sheetType}\n`;
    
    if (isTaxable) {
      report += `  âš ï¸ ê³¼ì„¸ ì‹œíŠ¸ (ë‹¨ê°€ì— VAT í¬í•¨)\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€Ã·1.1)\n`;
    } else if (sheetType === 'ì•½í’ˆ_ì˜ì„¸') {
      report += `  âœ… ì˜ì„¸ ì‹œíŠ¸ (VAT 0%)\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n`;
    } else {
      report += `  âœ… ì¼ë°˜ ì‹œíŠ¸\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n`;
    }
    
    const dataInfo = findDataRange(sheet);
    if (dataInfo) {
      report += `  âœ… ë°ì´í„° ì˜ì—­: ${dataInfo.startRow}~${dataInfo.endRow}í–‰\n`;
      
      const headerInfo = analyzeHeaders(sheet, dataInfo.headerRow);
      if (headerInfo.valid) {
        report += `  âœ… í•„ìˆ˜ ì—´ í™•ì¸ë¨\n`;
      } else {
        report += `  âŒ í•„ìˆ˜ ì—´ ëˆ„ë½\n`;
      }
    } else {
      report += `  âŒ ë°ì´í„° ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ\n`;
    }
  });
  
  ui.alert('ê±°ë˜ì²˜ì›ì¥ ë¶„ì„', report, ui.ButtonSet.OK);
}
