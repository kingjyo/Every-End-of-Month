/**
 * ê±°ë˜ì²˜ì›ì¥ ë°ì´í„° ì •ë¦¬ ëª¨ë“ˆ v3.5
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ìë™ íƒì§€
 * 2. ê³µê¸‰ê°€ì•¡ ê³„ì‚° 
 *    - ì¼ë°˜: ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
 *    - ê³¼ì„¸: ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€ Ã· 1.1)
 * 3. êµ¬ì…ëŸ‰(kg) ê³„ì‚° (ì¤‘ëŸ‰/ê·œê²© Ã— ìˆ˜ëŸ‰)
 * 4. ì”ì•¡ ëˆ„ì  ê³„ì‚°
 * 5. í’ˆëª…/ì ìš” í‘œì¤€í™”
 * 6. í•©ê³„ ìë™ ì¶”ê°€
 * 7. ë¶ˆí•„ìš”í•œ í–‰/ì—´ ì •ë¦¬ (B~Kì—´ + êµ¬ì…ëŸ‰ ì—´)
 * 8. êµ¬ë§¤ë‚´ì—­ì„œì™€ ê¸ˆì•¡ ê²€ì¦
 * 
 * ì´ ëª¨ë“ˆì€ ë°ì´í„°ë§Œ ì •ë¦¬í•˜ë©°, ì‹œíŠ¸ ì‚­ì œë‚˜ ê´€ë¦¬ëŠ” í•˜ì§€ ì•ŠìŒ
 */

/**
 * ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ë©”ì¸ í•¨ìˆ˜
 */
function processSupplierLedgers() {
  const ui = SpreadsheetApp.getUi();
  
  try {
    logDebug('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬', 'ì‹œì‘');
    
    // ê¸°ì¤€ ë…„/ì›” ê°€ì ¸ì˜¤ê¸°
    const baseDate = getBaseYearMonth();
    
    // ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì°¾ê¸°
    const ledgerSheets = findLedgerSheets(baseDate);
    
    if (ledgerSheets.length === 0) {
      ui.alert(
        'ì‹œíŠ¸ ì—†ìŒ',
        'ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        ui.ButtonSet.OK
      );
      return;
    }
    
    // ì²˜ë¦¬ í™•ì¸
    const response = ui.alert(
      'ğŸ’¼ ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬',
      `${ledgerSheets.length}ê°œì˜ ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:\n\n` +
      `${ledgerSheets.map(s => 'â€¢ ' + s.getName()).join('\n')}\n\n` +
      `ì‘ì—… ë‚´ìš©:\n` +
      `â€¢ ìˆ˜ì‹ì„ ê°’ìœ¼ë¡œ ë³€í™˜\n` +
      `â€¢ ê³µê¸‰ê°€ì•¡ ìë™ ê³„ì‚°\n` +
      `  - ì¼ë°˜/ì˜ì„¸: ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n` +
      `  - ê³¼ì„¸: ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€ Ã· 1.1)\n` +
      `â€¢ êµ¬ì…ëŸ‰(kg) ê³„ì‚° (ì¤‘ëŸ‰/ê·œê²© Ã— ìˆ˜ëŸ‰)\n` +
      `â€¢ ë¶€ê°€ì„¸ = ê³µê¸‰ê°€ì•¡ Ã— 10% ê³„ì‚°\n` +
      `â€¢ í’ˆëª…/ì ìš” í‘œì¤€í™”\n` +
      `â€¢ ì”ì•¡ ëˆ„ì  ê³„ì‚°\n` +
      `â€¢ B~Kì—´ + êµ¬ì…ëŸ‰ ì—´ ì •ë¦¬\n\n` +
      `ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      return;
    }
    
    // ê° ì‹œíŠ¸ ì²˜ë¦¬
    const results = [];
    let totalProcessed = 0;
    let totalAmount = 0;
    let totalPurchaseKg = 0;
    
    ledgerSheets.forEach(sheet => {
      try {
        const result = processLedgerSheet(sheet);
        results.push(result);
        totalProcessed += result.processedRows;
        totalAmount += result.totalAmount;
        totalPurchaseKg += result.totalPurchaseKg || 0;
        
        logDebug('ì‹œíŠ¸ ì²˜ë¦¬ ì™„ë£Œ', 
                 `${sheet.getName()}: ${result.processedRows}í–‰, ${formatAmount(result.totalAmount)}ì›, ${formatAmount(result.totalPurchaseKg)}kg`);
        
      } catch (error) {
        results.push({
          sheetName: sheet.getName(),
          success: false,
          error: error.toString()
        });
        logDebug('ì‹œíŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜', `${sheet.getName()}: ${error.toString()}`);
      }
    });
    
    // êµ¬ë§¤ë‚´ì—­ì„œì™€ ê¸ˆì•¡ ê²€ì¦
    const validation = validateWithPurchaseSheet(baseDate, totalAmount);
    
    // ê²°ê³¼ í‘œì‹œ
    showResults(results, totalProcessed, totalAmount, totalPurchaseKg, validation);
    
  } catch (error) {
    ui.alert('ì˜¤ë¥˜', `ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`, ui.ButtonSet.OK);
    logDebug('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì˜¤ë¥˜', error.toString());
  }
}

/**
 * ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì°¾ê¸°
 */
function findLedgerSheets(baseDate) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  const ledgerSheets = [];
  
  // ì°¾ì„ íŒ¨í„´ë“¤
  const patterns = [
    `ê±°ë˜ì²˜ì›ì¥${baseDate.yearShort}.${baseDate.month}`,
    `ê±°ë˜ì²˜ì›ì¥${baseDate.yearShort}.${baseDate.monthShort}`,
    `ê±°ë˜ì²˜ì›ì¥ ${baseDate.yearShort}.${baseDate.month}`,
    `ê±°ë˜ì²˜ì›ì¥ ${baseDate.yearShort}.${baseDate.monthShort}`,
    `ê±°ë˜ì²˜ ì›ì¥${baseDate.yearShort}`,
    `ê±°ë˜ì²˜ì›ì¥`
  ];
  
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const sheetNameLower = sheetName.toLowerCase();
    
    // ë³´í˜¸ ì‹œíŠ¸ëŠ” ì œì™¸ (ì´ ì •ë¦¬ í‘œ ë“±)
    if (sheetNameLower.includes('ì •ë¦¬') || sheetNameLower.includes('ì •ë¦¬í‘œ')) {
      return;
    }
    
    // êµ¬ë§¤ë‚´ì—­ì„œëŠ” ì œì™¸
    if (sheetNameLower.includes('êµ¬ë§¤ë‚´ì—­ì„œ')) {
      return;
    }
    
    // ê±°ë˜ì²˜ì›ì¥ íŒ¨í„´ í™•ì¸
    const isLedger = patterns.some(pattern => 
      sheetNameLower.includes(pattern.toLowerCase())
    ) || sheetNameLower.includes('ì›ì¥');
    
    if (isLedger) {
      // ë°ì´í„° êµ¬ì¡° í™•ì¸
      if (hasLedgerStructure(sheet)) {
        ledgerSheets.push(sheet);
        logDebug('ê±°ë˜ì²˜ì›ì¥ ë°œê²¬', sheetName);
      }
    }
  });
  
  return ledgerSheets;
}

/**
 * ê±°ë˜ì²˜ì›ì¥ êµ¬ì¡°ì¸ì§€ í™•ì¸
 */
function hasLedgerStructure(sheet) {
  try {
    const data = sheet.getDataRange().getValues();
    
    // ì²˜ìŒ 20í–‰ì—ì„œ "ê±°ë˜ì²˜ ì›ì¥" í…ìŠ¤íŠ¸ ì°¾ê¸°
    for (let i = 0; i < Math.min(20, data.length); i++) {
      for (let j = 0; j < Math.min(5, data[i].length); j++) {
        const cellValue = String(data[i][j]).toLowerCase();
        if (cellValue.includes('ê±°ë˜ì²˜') && cellValue.includes('ì›ì¥')) {
          return true;
        }
      }
    }
    
    // ë˜ëŠ” í—¤ë” í‚¤ì›Œë“œë¡œ íŒë‹¨
    const headerKeywords = ['ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'ê³µê¸‰ê°€', 'ê¸ˆì•¡', 'í’ˆëª…'];
    let keywordCount = 0;
    
    for (let i = 0; i < Math.min(15, data.length); i++) {
      const rowText = data[i].join(' ').toLowerCase();
      headerKeywords.forEach(keyword => {
        if (rowText.includes(keyword)) keywordCount++;
      });
      
      if (keywordCount >= 3) return true;
    }
    
    return false;
    
  } catch (error) {
    return false;
  }
}

/**
 * ê°œë³„ ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì²˜ë¦¬
 */
function processLedgerSheet(sheet) {
  const sheetName = sheet.getName();
  
  // ë¨¼ì € ëª¨ë“  ìˆ˜ì‹ì„ ê°’ìœ¼ë¡œ ë³€í™˜
  convertFormulasToValues(sheet);
  logDebug('ìˆ˜ì‹ ë³€í™˜', `${sheetName}: ëª¨ë“  ìˆ˜ì‹ì„ ê°’ìœ¼ë¡œ ë³€í™˜`);
  
  // ì‹œíŠ¸ íƒ€ì… íŒë³„
  const sheetType = detectSheetType(sheetName);
  const isTaxable = sheetType === 'ì•½í’ˆ_ê³¼ì„¸'; // ê³¼ì„¸ ì‹œíŠ¸ ì—¬ë¶€
  
  logDebug('ì‹œíŠ¸ íƒ€ì…', `${sheetName}: ${sheetType} (ê³¼ì„¸: ${isTaxable})`);
  
  // ë°ì´í„° ì˜ì—­ ì°¾ê¸° (í´ë¦°ì—…ì„ ìœ„í•´ titleRow ì •ë³´ë„ ì €ì¥)
  const dataInfo = findDataRangeWithTitle(sheet);
  if (!dataInfo) {
    throw new Error('ë°ì´í„° ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  // í—¤ë” ì •ë³´ ë¶„ì„
  const headerInfo = analyzeHeaders(sheet, dataInfo.headerRow);
  if (!headerInfo.valid) {
    throw new Error('í•„ìˆ˜ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
  
  // êµ¬ì…ëŸ‰ ê³„ì‚°ìš© ë°ì´í„° ì €ì¥
  const purchaseKgData = [];
  
  // ë°ì´í„° ì²˜ë¦¬
  let processedRows = 0;
  let totalAmount = 0;
  let totalPurchaseKg = 0;
  let runningBalance = 0;
  
  // ê° ë°ì´í„° í–‰ ì²˜ë¦¬
  for (let row = dataInfo.startRow; row <= dataInfo.endRow; row++) {
    try {
      // í–‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const rowData = sheet.getRange(row, 1, 1, sheet.getMaxColumns()).getValues()[0];
      
      // ë¹ˆ í–‰ ì²´í¬
      if (isEmptyRow(rowData, headerInfo.columns)) {
        continue;
      }
      
      // ìˆ˜ëŸ‰, ë‹¨ê°€, ì¤‘ëŸ‰/ê·œê²© ê°€ì ¸ì˜¤ê¸°
      const quantity = parseNumber(rowData[headerInfo.columns.quantity]);
      let unitPrice = parseNumber(rowData[headerInfo.columns.unitPrice]);
      
      // ì¤‘ëŸ‰ ë˜ëŠ” ê·œê²© ê°’ ê°€ì ¸ì˜¤ê¸°
      let weight = 0;
      if (headerInfo.columns.weight !== undefined) {
        weight = parseNumber(rowData[headerInfo.columns.weight]);
      } else if (headerInfo.columns.spec !== undefined) {
        weight = parseNumber(rowData[headerInfo.columns.spec]);
      }
      
      // êµ¬ì…ëŸ‰(kg) ê³„ì‚° = ì¤‘ëŸ‰/ê·œê²© Ã— ìˆ˜ëŸ‰
      const purchaseKg = weight * quantity;
      purchaseKgData.push(purchaseKg);
      totalPurchaseKg += purchaseKg;
      
      // ê³µê¸‰ê°€ì•¡ ê³„ì‚°
      let supplyAmount = 0;
      
      if (isTaxable) {
        // ê³¼ì„¸ ì‹œíŠ¸: ë‹¨ê°€ì— ë¶€ê°€ì„¸ í¬í•¨ë˜ì–´ ìˆìŒ
        const priceWithoutVAT = unitPrice / 1.1;
        const roundedPrice = Math.round(priceWithoutVAT * 10000) / 10000;
        supplyAmount = Math.round(weight * quantity * roundedPrice);
        
        logDebug('ê³¼ì„¸ ê³„ì‚°', 
                 `í–‰ ${row}: ë‹¨ê°€ ${unitPrice} â†’ VATì œì™¸ ${roundedPrice} Ã— ìˆ˜ëŸ‰ ${quantity} Ã— ì¤‘ëŸ‰ ${weight} = ${supplyAmount}`);
        
      } else {
        // ì¼ë°˜/ì˜ì„¸ ì‹œíŠ¸
        supplyAmount = Math.round(weight * quantity * unitPrice);
      }
      
      if (supplyAmount > 0 || purchaseKg > 0) {
        // ê³µê¸‰ê°€ì•¡ ì„¤ì •
        sheet.getRange(row, headerInfo.columns.supplyAmount + 1).setValue(supplyAmount);
        sheet.getRange(row, headerInfo.columns.supplyAmount + 1).setNumberFormat('#,##0');
        
        // ë¶€ê°€ì„¸ ê³„ì‚°
        if (headerInfo.columns.vat !== undefined) {
          let vat = 0;
          
          if (isTaxable) {
            vat = Math.round(supplyAmount * 0.1);
          } else if (sheetType === 'ì•½í’ˆ_ì˜ì„¸') {
            vat = 0;
          } else {
            vat = Math.round(supplyAmount * 0.1);
          }
          
          sheet.getRange(row, headerInfo.columns.vat + 1).setValue(vat);
          sheet.getRange(row, headerInfo.columns.vat + 1).setNumberFormat('#,##0');
        }
        
        // í•©ê³„
        if (headerInfo.columns.total !== undefined) {
          const vat = headerInfo.columns.vat !== undefined ? 
                      parseNumber(sheet.getRange(row, headerInfo.columns.vat + 1).getValue()) : 0;
          const total = supplyAmount + vat;
          
          sheet.getRange(row, headerInfo.columns.total + 1).setValue(total);
          sheet.getRange(row, headerInfo.columns.total + 1).setNumberFormat('#,##0');
        }
        
        // ì”ì•¡ ëˆ„ì 
        runningBalance += supplyAmount;
        if (headerInfo.columns.balance !== undefined) {
          sheet.getRange(row, headerInfo.columns.balance + 1).setValue(runningBalance);
          sheet.getRange(row, headerInfo.columns.balance + 1).setNumberFormat('#,##0');
        }
        
        totalAmount += supplyAmount;
        processedRows++;
      }
      
      // í’ˆëª… í‘œì¤€í™”
      if (headerInfo.columns.description !== undefined) {
        const originalName = rowData[headerInfo.columns.description];
        const standardName = standardizeItemName(originalName, sheetType);
        if (standardName !== originalName) {
          sheet.getRange(row, headerInfo.columns.description + 1).setValue(standardName);
        }
      }
      
    } catch (error) {
      logDebug('í–‰ ì²˜ë¦¬ ì˜¤ë¥˜', `${sheetName} ${row}í–‰: ${error.toString()}`);
    }
  }
  
  // í•©ê³„ í–‰ ì¶”ê°€
  let totalRow = dataInfo.endRow + 1;
  if (totalAmount > 0 && totalRow <= sheet.getMaxRows()) {
    addTotalRow(sheet, totalRow, headerInfo.columns, totalAmount, isTaxable);
  } else {
    totalRow = dataInfo.endRow; // í•©ê³„ê°€ ì—†ìœ¼ë©´ ë°ì´í„° ëì´ ë§ˆì§€ë§‰
  }
  
  // ì‹œíŠ¸ ì •ë¦¬ (B~Kì—´ë§Œ ë‚¨ê¸°ê³  ì •ë¦¬)
  const cleanupResult = cleanupLedgerSheet(sheet, dataInfo, totalRow);
  
  // êµ¬ì…ëŸ‰(kg) ì—´ ì¶”ê°€ - ì •ë¦¬ í›„ì— ì¶”ê°€
  addPurchaseKgColumn(sheet, purchaseKgData, totalPurchaseKg);
  
  return {
    sheetName: sheetName,
    sheetType: sheetType,
    isTaxable: isTaxable,
    success: true,
    processedRows: processedRows,
    totalAmount: totalAmount,
    totalPurchaseKg: totalPurchaseKg,
    dataRange: `${dataInfo.startRow}~${dataInfo.endRow}í–‰`,
    cleanedUp: cleanupResult
  };
}

/**
 * êµ¬ì…ëŸ‰(kg) ì—´ ì¶”ê°€ - ìˆ˜ì •ëœ ë²„ì „
 */
function addPurchaseKgColumn(sheet, purchaseKgData, totalPurchaseKg) {
  try {
    // ì •ë¦¬ í›„ í—¤ë”ëŠ” í•­ìƒ 3ë²ˆì§¸ í–‰
    const headerRow = 3;
    const headers = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns()).getValues()[0];
    
    // ìˆ˜ëŸ‰ ì—´ ì°¾ê¸°
    let quantityCol = -1;
    for (let i = 0; i < headers.length; i++) {
      const header = String(headers[i]).toLowerCase().replace(/\s/g, '');
      if (header === 'ìˆ˜ëŸ‰' || header === 'ìˆ˜' || header.includes('ìˆ˜ëŸ‰')) {
        quantityCol = i + 1; // 1-based index
        break;
      }
    }
    
    if (quantityCol === -1) {
      logDebug('êµ¬ì…ëŸ‰ ì—´ ì¶”ê°€ ì‹¤íŒ¨', 'ìˆ˜ëŸ‰ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return;
    }
    
    // ìˆ˜ëŸ‰ ë‹¤ìŒ ì—´ì— ì‚½ì…
    const insertCol = quantityCol + 1;
    sheet.insertColumnAfter(quantityCol);
    
    // í—¤ë” ì„¤ì •
    sheet.getRange(headerRow, insertCol).setValue('êµ¬ì…ëŸ‰(kg)');
    sheet.getRange(headerRow, insertCol).setFontWeight('bold');
    sheet.getRange(headerRow, insertCol).setBackground('#e8e8e8');
    sheet.getRange(headerRow, insertCol).setBorder(true, true, true, true, true, true);
    
    // ë°ì´í„° í–‰ì— êµ¬ì…ëŸ‰ ê°’ ì…ë ¥
    const dataStartRow = headerRow + 1;
    let dataIndex = 0;
    
    // í•©ê³„ í–‰ ì°¾ê¸° (Bì—´ì— "í•©ê³„"ê°€ ìˆëŠ” í–‰)
    let totalRowNum = -1;
    const maxRows = sheet.getMaxRows();
    
    for (let row = dataStartRow; row <= maxRows; row++) {
      const cellValue = sheet.getRange(row, 1).getValue(); // Bì—´ (ì •ë¦¬ í›„ 1ì—´)
      if (String(cellValue).includes('í•©ê³„')) {
        totalRowNum = row;
        break;
      }
    }
    
    if (totalRowNum === -1) {
      // í•©ê³„ í–‰ì„ ëª» ì°¾ìœ¼ë©´ ë§ˆì§€ë§‰ ë°ì´í„°ê°€ ìˆëŠ” í–‰ ì°¾ê¸°
      for (let row = maxRows; row >= dataStartRow; row--) {
        const rowData = sheet.getRange(row, 1, 1, sheet.getMaxColumns()).getValues()[0];
        if (rowData.some(cell => cell !== '' && cell !== null)) {
          totalRowNum = row;
          break;
        }
      }
    }
    
    logDebug('í•©ê³„ í–‰ ìœ„ì¹˜', `${totalRowNum}í–‰`);
    
    // ë°ì´í„° ì…ë ¥
    for (let row = dataStartRow; row < totalRowNum && dataIndex < purchaseKgData.length; row++) {
      // í˜„ì¬ í–‰ì´ ë°ì´í„° í–‰ì¸ì§€ í™•ì¸
      const rowData = sheet.getRange(row, 1, 1, sheet.getMaxColumns()).getValues()[0];
      const hasData = rowData.some(cell => cell !== '' && cell !== null && String(cell) !== '0');
      
      if (hasData) {
        sheet.getRange(row, insertCol).setValue(purchaseKgData[dataIndex]);
        sheet.getRange(row, insertCol).setNumberFormat('#,##0');
        sheet.getRange(row, insertCol).setBorder(true, true, true, true, false, false);
        dataIndex++;
      }
    }
    
    // í•©ê³„ í–‰ì— êµ¬ì…ëŸ‰ í•©ê³„ ì¶”ê°€
    if (totalRowNum > 0) {
      sheet.getRange(totalRowNum, insertCol).setValue(totalPurchaseKg);
      sheet.getRange(totalRowNum, insertCol).setNumberFormat('#,##0');
      sheet.getRange(totalRowNum, insertCol).setFontWeight('bold');
      sheet.getRange(totalRowNum, insertCol).setBackground('#f0f0f0');
      sheet.getRange(totalRowNum, insertCol).setBorder(true, true, true, true, true, true);
    }
    
    logDebug('êµ¬ì…ëŸ‰ ì—´ ì¶”ê°€ ì™„ë£Œ', 
             `${insertCol}ì—´ì— ì¶”ê°€, ë°ì´í„° ${dataIndex}ê°œ, í•©ê³„: ${formatAmount(totalPurchaseKg)}kg (${totalRowNum}í–‰)`);
    
  } catch (error) {
    logDebug('êµ¬ì…ëŸ‰ ì—´ ì¶”ê°€ ì˜¤ë¥˜', error.toString());
  }
}

/**
 * ëª¨ë“  ìˆ˜ì‹ì„ ê°’ìœ¼ë¡œ ë³€í™˜
 */
function convertFormulasToValues(sheet) {
  const range = sheet.getDataRange();
  const values = range.getValues();
  range.setValues(values);
}

/**
 * ì‹œíŠ¸ íƒ€ì… íŒë³„
 */
function detectSheetType(sheetName) {
  const nameLower = sheetName.toLowerCase();
  
  // ê³¼ì„¸ í™•ì¸ì´ ìµœìš°ì„ 
  if (nameLower.includes('ê³¼ì„¸')) {
    return 'ì•½í’ˆ_ê³¼ì„¸';
  }
  
  // ì˜ì„¸ í™•ì¸
  if (nameLower.includes('ì˜ì„¸')) {
    return 'ì•½í’ˆ_ì˜ì„¸';
  }
  
  // ê¸°íƒ€ íƒ€ì…
  if (nameLower.includes('í“¨ë¦¬ë‚˜')) return 'ì‚¬ë£Œ';
  if (nameLower.includes('ì œì¶•ì„¬ìœ ì§ˆ')) return 'ì—°ë§¥';
  if (nameLower.includes('í˜„í´ë¦¬ë‹‰')) return 'ì•½í’ˆ';
  
  return 'ê¸°íƒ€';
}

/**
 * ë°ì´í„° ì˜ì—­ ì°¾ê¸° (íƒ€ì´í‹€ í–‰ í¬í•¨) - ê°œì„ ëœ ë²„ì „
 */
function findDataRangeWithTitle(sheet) {
  const maxRows = sheet.getMaxRows();
  
  // Bì—´ì—ì„œ "ê±°ë˜ì²˜ ì›ì¥" ì°¾ê¸°
  for (let row = 1; row <= Math.min(30, maxRows); row++) {
    const cellValue = sheet.getRange(row, 2).getValue();
    
    if (cellValue && String(cellValue).includes('ê±°ë˜ì²˜')) {
      const titleStartRow = row;
      
      // "ê±°ë˜ì²˜ ì›ì¥"ì´ ì—¬ëŸ¬ í–‰ì— ê±¸ì³ìˆì„ ìˆ˜ ìˆìŒ (ë³´í†µ 1-2í–‰)
      let titleEndRow = titleStartRow;
      if (row + 1 <= maxRows) {
        const nextCellValue = sheet.getRange(row + 1, 2).getValue();
        if (nextCellValue && String(nextCellValue).includes('ì›ì¥')) {
          titleEndRow = row + 1;
        }
      }
      
      // ë¨¼ì € +5 ì‹œë„
      let headerRow = titleStartRow + 5;
      let headerFound = false;
      
      if (headerRow <= maxRows) {
        const headerRange = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns());
        const headers = headerRange.getValues()[0];
        const headerText = headers.join(' ').toLowerCase();
        
        if (headerText.includes('ë‚ ì§œ') || headerText.includes('í’ˆëª…') || headerText.includes('ìˆ˜ëŸ‰')) {
          headerFound = true;
        }
      }
      
      // +5ê°€ ì•ˆë˜ë©´ +4 ì‹œë„
      if (!headerFound) {
        headerRow = titleStartRow + 4;
        
        if (headerRow <= maxRows) {
          const headerRange = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns());
          const headers = headerRange.getValues()[0];
          const headerText = headers.join(' ').toLowerCase();
          
          if (headerText.includes('ë‚ ì§œ') || headerText.includes('í’ˆëª…') || headerText.includes('ìˆ˜ëŸ‰')) {
            headerFound = true;
            logDebug('í—¤ë” ìœ„ì¹˜', `${sheet.getName()}: +4 ìœ„ì¹˜ì—ì„œ í—¤ë” ë°œê²¬`);
          }
        }
      } else {
        logDebug('í—¤ë” ìœ„ì¹˜', `${sheet.getName()}: +5 ìœ„ì¹˜ì—ì„œ í—¤ë” ë°œê²¬`);
      }
      
      if (headerFound) {
        // ë°ì´í„° ì‹œì‘ê³¼ ë ì°¾ê¸°
        const dataStartRow = headerRow + 1;
        let dataEndRow = dataStartRow;
        
        for (let checkRow = dataStartRow; checkRow <= maxRows; checkRow++) {
          const rowData = sheet.getRange(checkRow, 2, 1, 5).getValues()[0];
          const hasData = rowData.some(cell => cell !== '' && cell !== null);
          
          if (!hasData) {
            // ì—°ì† 2ê°œ ë¹ˆ í–‰ì´ë©´ ì¢…ë£Œ
            if (checkRow + 1 <= maxRows) {
              const nextRowData = sheet.getRange(checkRow + 1, 2, 1, 5).getValues()[0];
              if (!nextRowData.some(cell => cell !== '' && cell !== null)) {
                dataEndRow = checkRow - 1;
                break;
              }
            }
          } else {
            dataEndRow = checkRow;
          }
        }
        
        return {
          titleStartRow: titleStartRow,
          titleEndRow: titleEndRow,
          headerRow: headerRow,
          startRow: dataStartRow,
          endRow: dataEndRow
        };
      }
    }
  }
  
  return null;
}

/**
 * í—¤ë” ë¶„ì„ - ì¤‘ëŸ‰/ê·œê²© ì²˜ë¦¬ ì¶”ê°€
 */
function analyzeHeaders(sheet, headerRow) {
  const headers = sheet.getRange(headerRow, 1, 1, sheet.getMaxColumns()).getValues()[0];
  const columns = {};
  
  // ê° í—¤ë” ì°¾ê¸° (0-based index)
  headers.forEach((header, index) => {
    const h = String(header).toLowerCase().replace(/\s/g, '');
    
    if (h.includes('ë‚ ì§œ') || h.includes('ì¼ì')) columns.date = index;
    if (h.includes('í’ˆëª…') || h.includes('ì ìš”')) columns.description = index;
    
    // ì¤‘ëŸ‰ ë˜ëŠ” ê·œê²© ì°¾ê¸°
    if (h.includes('ì¤‘ëŸ‰') || h === 'ì¤‘') {
      columns.weight = index;
    } else if (h.includes('ê·œê²©')) {
      columns.spec = index;
    }
    
    if ((h === 'ìˆ˜ëŸ‰' || h === 'ìˆ˜' || h.includes('ìˆ˜ëŸ‰')) && !h.includes('ë‹¨')) columns.quantity = index;
    if (h.includes('ë‹¨ê°€') || h === 'ë‹¨') columns.unitPrice = index;
    if (h.includes('ê³µê¸‰ê°€') || h === 'ê³µê¸‰ì•¡' || h === 'ê¸ˆì•¡') columns.supplyAmount = index;
    if (h.includes('ë¶€ê°€ì„¸') || h.includes('ì„¸ì•¡')) columns.vat = index;
    if (h === 'í•©ê³„' || h === 'ì´ì•¡' || h.includes('í•©ê³„')) columns.total = index;
    if (h.includes('ì”ì•¡') || h.includes('ì”ê³ ')) columns.balance = index;
  });
  
  // í•„ìˆ˜ ì—´ í™•ì¸
  const valid = columns.quantity !== undefined && 
                columns.unitPrice !== undefined && 
                columns.supplyAmount !== undefined;
  
  const weightColumn = columns.weight !== undefined ? 'ì¤‘ëŸ‰' : 
                       columns.spec !== undefined ? 'ê·œê²©' : 'ì—†ìŒ';
  
  logDebug('í—¤ë” ë¶„ì„', 
           `ìˆ˜ëŸ‰:${columns.quantity}, ë‹¨ê°€:${columns.unitPrice}, ê³µê¸‰ê°€:${columns.supplyAmount}, ${weightColumn}:${columns.weight || columns.spec}`);
  
  return { valid, columns };
}

/**
 * ë¹ˆ í–‰ í™•ì¸
 */
function isEmptyRow(rowData, columns) {
  // ë‚ ì§œ, í’ˆëª…, ìˆ˜ëŸ‰, ë‹¨ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ í–‰
  const hasDate = columns.date !== undefined && rowData[columns.date];
  const hasDesc = columns.description !== undefined && rowData[columns.description];
  const hasQty = columns.quantity !== undefined && parseNumber(rowData[columns.quantity]) > 0;
  const hasPrice = columns.unitPrice !== undefined && parseNumber(rowData[columns.unitPrice]) > 0;
  
  return !hasDate && !hasDesc && !hasQty && !hasPrice;
}

/**
 * ìˆ«ì íŒŒì‹±
 */
function parseNumber(value) {
  if (typeof value === 'number') return value;
  if (!value) return 0;
  
  let str = String(value);
  str = str.replace(/[,\sì›â‚©$]/g, '');
  
  if (str.startsWith('(') && str.endsWith(')')) {
    str = '-' + str.slice(1, -1);
  }
  
  const num = parseFloat(str);
  return isNaN(num) ? 0 : num;
}

/**
 * í’ˆëª… í‘œì¤€í™”
 */
function standardizeItemName(name, sheetType) {
  if (!name) return '';
  
  let standardized = String(name).trim();
  
  switch(sheetType) {
    case 'ì‚¬ë£Œ':
      return standardizeFeedName(standardized);
    case 'ì•½í’ˆ_ì˜ì„¸':
    case 'ì•½í’ˆ_ê³¼ì„¸':
    case 'ì•½í’ˆ':
      return standardizeMedicineName(standardized);
    case 'ì—°ë§¥':
      return 'ì—°ë§¥';
    default:
      return standardized;
  }
}

/**
 * ì‚¬ë£Œëª… í‘œì¤€í™”
 */
function standardizeFeedName(name) {
  // (í“¨) ì œê±°
  name = name.replace(/[ï¼ˆ(]í“¨[)ï¼‰]/g, '');
  
  // ì†¡ì•„ì§€ë³¸ ì²˜ë¦¬
  if (name.includes('ì†¡ì•„ì§€ë³¸')) {
    if (name.includes('110')) return 'ì†¡ì•„ì§€ë³¸ 110+';
    if (name.includes('230')) return 'ì†¡ì•„ì§€ë³¸ 230+';
  }
  
  // í¬ì»¤ìŠ¤ ì œí’ˆ
  if (name.includes('í¬ì»¤ìŠ¤')) {
    const isBulk = name.includes('ë²Œí¬');
    
    if (name.includes('ë§ˆë¬´ë¦¬')) return `í¬ì»¤ìŠ¤ë§ˆë¬´ë¦¬ ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('ìœ¡ì„±')) {
      if (name.includes('ì•”/ìˆ˜') || name.includes('ì•”ìˆ˜')) {
        return `í¬ì»¤ìŠ¤ìœ¡ì„±(ì•”/ìˆ˜) ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
      }
      return `í¬ì»¤ìŠ¤ìœ¡ì„± ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    }
    if (name.includes('ì„ì‹ ìš°')) return `í¬ì»¤ìŠ¤ì„ì‹ ìš° ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('í°ì†Œ')) return `í¬ì»¤ìŠ¤í°ì†Œ ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
    if (name.includes('ë²ˆì‹ìš°')) return `í¬ì»¤ìŠ¤ë²ˆì‹ìš° ${isBulk ? 'ë²Œí¬' : 'ì§€ëŒ€'}`;
  }
  
  return name;
}

/**
 * ì•½í’ˆëª… í‘œì¤€í™”
 */
function standardizeMedicineName(name) {
  // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤
  if (name.includes('í”Œë¡œë¦¬ë¶€ìŠ¤í„°-ê°ˆí”„')) return name;
  
  // ë¹„ì˜¤ì“°ë¦¬ íŠ¹ìˆ˜ ì²˜ë¦¬
  if (name.includes('ë¹„ì˜¤ì“°ë¦¬') && name.includes('(ë™-ì‚¼ì–‘)')) {
    return name.replace(/\(ë™-ì‚¼ì–‘\)(\d+[a-zA-Z]+)/g, '(ë™-ì‚¼ì–‘)-$1');
  }
  
  // ì¼ë°˜ì ì¸ ê²½ìš°: ì•½í’ˆëª…-ê·œê²©
  const pattern = /^([^-\d]+)(\d+[a-zA-Z]+)$/;
  const match = name.match(pattern);
  
  if (match) {
    return match[1] + '-' + match[2];
  }
  
  return name;
}

/**
 * í•©ê³„ í–‰ ì¶”ê°€
 */
function addTotalRow(sheet, row, columns, totalAmount, isTaxable) {
  try {
    // "í•©ê³„" í‘œì‹œ
    if (columns.description !== undefined) {
      sheet.getRange(row, columns.description + 1).setValue('í•©ê³„');
    } else if (columns.date !== undefined) {
      sheet.getRange(row, columns.date + 1).setValue('í•©ê³„');
    }
    
    // ì´ì•¡ í‘œì‹œ
    sheet.getRange(row, columns.supplyAmount + 1).setValue(totalAmount);
    sheet.getRange(row, columns.supplyAmount + 1).setNumberFormat('#,##0');
    
    // ë¶€ê°€ì„¸ í•©ê³„ (ê³¼ì„¸ì¸ ê²½ìš°ë§Œ)
    if (columns.vat !== undefined && isTaxable) {
      const totalVat = Math.round(totalAmount * 0.1);
      sheet.getRange(row, columns.vat + 1).setValue(totalVat);
      sheet.getRange(row, columns.vat + 1).setNumberFormat('#,##0');
      
      // ì „ì²´ í•©ê³„ (ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸)
      if (columns.total !== undefined) {
        sheet.getRange(row, columns.total + 1).setValue(totalAmount + totalVat);
        sheet.getRange(row, columns.total + 1).setNumberFormat('#,##0');
      }
    }
    
    // ì„œì‹ ì„¤ì •
    sheet.getRange(row, 1, 1, sheet.getMaxColumns()).setFontWeight('bold');
    sheet.getRange(row, 1, 1, sheet.getMaxColumns()).setBackground('#f0f0f0');
    
    logDebug('í•©ê³„ ì¶”ê°€', `${row}í–‰ì— ${formatAmount(totalAmount)}ì› (ê³¼ì„¸: ${isTaxable})`);
    
  } catch (error) {
    logDebug('í•©ê³„ ì¶”ê°€ ì˜¤ë¥˜', error.toString());
  }
}

/**
 * ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ ì •ë¦¬ (B~Kì—´ë§Œ ë‚¨ê¸°ê³  ì •ë¦¬)
 */
function cleanupLedgerSheet(sheet, dataInfo, totalRow) {
  try {
    logDebug('ì‹œíŠ¸ ì •ë¦¬ ì‹œì‘', sheet.getName());
    
    // 1. íƒ€ì´í‹€ ì• í–‰ ì‚­ì œ
    if (dataInfo.titleStartRow > 1) {
      const rowsToDelete = dataInfo.titleStartRow - 1;
      sheet.deleteRows(1, rowsToDelete);
      
      // í–‰ ì‚­ì œ í›„ ì¸ë±ìŠ¤ ì¡°ì •
      dataInfo.titleStartRow -= rowsToDelete;
      dataInfo.titleEndRow -= rowsToDelete;
      dataInfo.headerRow -= rowsToDelete;
      dataInfo.startRow -= rowsToDelete;
      dataInfo.endRow -= rowsToDelete;
      totalRow -= rowsToDelete;
      
      logDebug('ìƒë‹¨ í–‰ ì‚­ì œ', `${rowsToDelete}ê°œ í–‰ ì‚­ì œ`);
    }
    
    // 2. íƒ€ì´í‹€ê³¼ í—¤ë” ì‚¬ì´ ë¶ˆí•„ìš”í•œ í–‰ ì‚­ì œ
    const gapRows = dataInfo.headerRow - dataInfo.titleEndRow - 1;
    if (gapRows > 2) {
      const rowsToDelete = gapRows - 1;
      sheet.deleteRows(dataInfo.titleEndRow + 2, rowsToDelete);
      
      // ì¸ë±ìŠ¤ ì¡°ì •
      dataInfo.headerRow -= rowsToDelete;
      dataInfo.startRow -= rowsToDelete;
      dataInfo.endRow -= rowsToDelete;
      totalRow -= rowsToDelete;
      
      logDebug('ì¤‘ê°„ í–‰ ì •ë¦¬', `${rowsToDelete}ê°œ í–‰ ì‚­ì œ`);
    }
    
    // 3. í•©ê³„ ì´í›„ í–‰ ì‚­ì œ
    const maxRows = sheet.getMaxRows();
    if (totalRow < maxRows) {
      const rowsToDelete = maxRows - totalRow;
      sheet.deleteRows(totalRow + 1, rowsToDelete);
      logDebug('í•˜ë‹¨ í–‰ ì‚­ì œ', `${rowsToDelete}ê°œ í–‰ ì‚­ì œ`);
    }
    
    // 4. Aì—´ ì‚­ì œ
    if (sheet.getMaxColumns() >= 1) {
      sheet.deleteColumn(1);
      logDebug('Aì—´ ì‚­ì œ', 'ì™„ë£Œ');
    }
    
    // 5. Kì—´ ì´í›„ ì‚­ì œ (KëŠ” 10ë²ˆì§¸ ì—´ì´ë¯€ë¡œ, Aì—´ ì‚­ì œ í›„ KëŠ” 10ë²ˆì§¸)
    const maxCols = sheet.getMaxColumns();
    if (maxCols > 10) {
      const colsToDelete = maxCols - 10;
      sheet.deleteColumns(11, colsToDelete);
      logDebug('Kì—´ ì´í›„ ì‚­ì œ', `${colsToDelete}ê°œ ì—´ ì‚­ì œ`);
    }
    
    // 6. ì„œì‹ ì •ë¦¬
    const finalCols = 10; // B~Kì—´ (Aì—´ ì‚­ì œ í›„)
    
    // íƒ€ì´í‹€ ì„œì‹
    const titleRange = sheet.getRange(dataInfo.titleStartRow, 1, 
                                     dataInfo.titleEndRow - dataInfo.titleStartRow + 1, 
                                     finalCols);
    titleRange.setFontWeight('bold');
    titleRange.setFontSize(12);
    titleRange.setHorizontalAlignment('center');
    
    // í—¤ë” ì„œì‹
    const headerRange = sheet.getRange(dataInfo.headerRow, 1, 1, finalCols);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#e8e8e8');
    headerRange.setBorder(true, true, true, true, true, true);
    
    // ë°ì´í„° ì˜ì—­ í…Œë‘ë¦¬
    const dataRange = sheet.getRange(dataInfo.startRow, 1, 
                                    totalRow - dataInfo.startRow + 1, 
                                    finalCols);
    dataRange.setBorder(true, true, true, true, true, true);
    
    logDebug('ì‹œíŠ¸ ì •ë¦¬ ì™„ë£Œ', `${sheet.getName()} - B~Kì—´ë§Œ ë‚¨ê¹€`);
    
    return {
      success: true,
      finalSize: `${totalRow}í–‰ Ã— ${finalCols}ì—´ (B~K)`
    };
    
  } catch (error) {
    logDebug('ì‹œíŠ¸ ì •ë¦¬ ì˜¤ë¥˜', `${sheet.getName()}: ${error.toString()}`);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * êµ¬ë§¤ë‚´ì—­ì„œì™€ ê¸ˆì•¡ ê²€ì¦
 */
function validateWithPurchaseSheet(baseDate, totalAmount) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // êµ¬ë§¤ë‚´ì—­ì„œ ì‹œíŠ¸ëª… íŒ¨í„´
    const targetSheetName = `${baseDate.monthShort}ì›” êµ¬ë§¤ë‚´ì—­ì„œ_${baseDate.yearShort}.${baseDate.monthShort}ì›” êµ¬ë§¤ë‚´ì—­ì„œ`;
    const sheet = spreadsheet.getSheetByName(targetSheetName);
    
    if (!sheet) {
      logDebug('ê²€ì¦', `êµ¬ë§¤ë‚´ì—­ì„œ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${targetSheetName}`);
      return {
        found: false,
        sheetName: targetSheetName
      };
    }
    
    // Cì—´ì—ì„œ "Mì›” í•œêµ­ê³µí•­ ì²­êµ¬ ê¸ˆì•¡" ì°¾ê¸°
    const searchText = `${baseDate.monthShort}ì›” í•œêµ­ê³µí•­ ì²­êµ¬ ê¸ˆì•¡`;
    const data = sheet.getDataRange().getValues();
    let targetRow = -1;
    
    for (let i = 0; i < data.length; i++) {
      const cellValue = String(data[i][2]); // Cì—´ (index 2)
      if (cellValue.includes(searchText)) {
        targetRow = i;
        break;
      }
    }
    
    if (targetRow === -1) {
      logDebug('ê²€ì¦', `ì²­êµ¬ ê¸ˆì•¡ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${searchText}`);
      return {
        found: false,
        sheetName: targetSheetName,
        searchText: searchText
      };
    }
    
    // Eì—´ì˜ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
    const claimAmount = parseNumber(data[targetRow][4]); // Eì—´ (index 4)
    const difference = Math.abs(claimAmount - totalAmount);
    
    logDebug('ê¸ˆì•¡ ê²€ì¦', 
             `ì²­êµ¬ì•¡: ${formatAmount(claimAmount)}ì›, ê±°ë˜ì²˜ì›ì¥ í•©ê³„: ${formatAmount(totalAmount)}ì›, ì°¨ì´: ${difference}ì›`);
    
    return {
      found: true,
      sheetName: targetSheetName,
      claimAmount: claimAmount,
      ledgerTotal: totalAmount,
      difference: difference,
      isValid: difference <= 100
    };
    
  } catch (error) {
    logDebug('ê²€ì¦ ì˜¤ë¥˜', error.toString());
    return {
      found: false,
      error: error.toString()
    };
  }
}

/**
 * ì²˜ë¦¬ ê²°ê³¼ í‘œì‹œ (ê²€ì¦ ê²°ê³¼ í¬í•¨)
 */
function showResults(results, totalProcessed, totalAmount, totalPurchaseKg, validation) {
  const ui = SpreadsheetApp.getUi();
  
  let message = 'ğŸ“Š ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì™„ë£Œ\n\n';
  
  const successResults = results.filter(r => r.success);
  const failedResults = results.filter(r => !r.success);
  
  if (successResults.length > 0) {
    message += 'âœ… ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ ì‹œíŠ¸:\n';
    successResults.forEach(result => {
      message += `\nğŸ“‹ ${result.sheetName} (${result.sheetType})\n`;
      if (result.isTaxable) {
        message += `  â€¢ âš ï¸ ê³¼ì„¸ ì‹œíŠ¸ (ë‹¨ê°€Ã·1.1 ì ìš©)\n`;
      }
      message += `  â€¢ ì²˜ë¦¬ ë²”ìœ„: ${result.dataRange}\n`;
      message += `  â€¢ ì²˜ë¦¬ëœ í–‰: ${result.processedRows}ê°œ\n`;
      message += `  â€¢ ê¸ˆì•¡ í•©ê³„: ${formatAmount(result.totalAmount)}ì›\n`;
      message += `  â€¢ êµ¬ì…ëŸ‰ í•©ê³„: ${formatAmount(result.totalPurchaseKg)}kg\n`;
      
      if (result.cleanedUp && result.cleanedUp.success) {
        message += `  â€¢ ğŸ§¹ ì •ë¦¬ ì™„ë£Œ: ${result.cleanedUp.finalSize}\n`;
      }
    });
  }
  
  if (failedResults.length > 0) {
    message += '\nâš ï¸ ì²˜ë¦¬ ì‹¤íŒ¨:\n';
    failedResults.forEach(result => {
      message += `  â€¢ ${result.sheetName}: ${result.error}\n`;
    });
  }
  
  message += `\nğŸ“Œ ì „ì²´ ìš”ì•½:\n`;
  message += `  â€¢ ì²˜ë¦¬ëœ í–‰: ${totalProcessed}ê°œ\n`;
  message += `  â€¢ ì´ ê¸ˆì•¡: ${formatAmount(totalAmount)}ì›\n`;
  message += `  â€¢ ì´ êµ¬ì…ëŸ‰: ${formatAmount(totalPurchaseKg)}kg\n`;
  message += `  â€¢ ì‹œíŠ¸ ì •ë¦¬: B~Kì—´ + êµ¬ì…ëŸ‰(kg) ì—´\n`;
  
  // ê²€ì¦ ê²°ê³¼ ì¶”ê°€
  if (validation.found) {
    message += `\nğŸ” ê¸ˆì•¡ ê²€ì¦:\n`;
    message += `  â€¢ êµ¬ë§¤ë‚´ì—­ì„œ ì²­êµ¬ì•¡: ${formatAmount(validation.claimAmount)}ì›\n`;
    message += `  â€¢ ê±°ë˜ì²˜ì›ì¥ í•©ê³„: ${formatAmount(validation.ledgerTotal)}ì›\n`;
    message += `  â€¢ ì°¨ì´: ${formatAmount(validation.difference)}ì›\n`;
    
    if (validation.isValid) {
      message += `\nâœ¨ ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì„±ê³µ! (ì°¨ì´ 100ì› ì´í•˜)`;
    } else {
      message += `\nâš ï¸ ì£¼ì˜: ê¸ˆì•¡ ì°¨ì´ê°€ 100ì›ì„ ì´ˆê³¼í•©ë‹ˆë‹¤!`;
    }
  } else {
    message += `\nğŸ“ ì°¸ê³ : êµ¬ë§¤ë‚´ì—­ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸ˆì•¡ ê²€ì¦ì„ ìˆ˜í–‰í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`;
  }
  
  ui.alert('ê±°ë˜ì²˜ì›ì¥ ì •ë¦¬ ì™„ë£Œ', message, ui.ButtonSet.OK);
}

/**
 * ê¸ˆì•¡ í¬ë§·íŒ…
 */
function formatAmount(amount) {
  return Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

/**
 * ê±°ë˜ì²˜ì›ì¥ ë¶„ì„ (í…ŒìŠ¤íŠ¸ìš©)
 */
function analyzeSupplierLedgers() {
  const ui = SpreadsheetApp.getUi();
  const baseDate = getBaseYearMonth();
  const ledgerSheets = findLedgerSheets(baseDate);
  
  if (ledgerSheets.length === 0) {
    ui.alert('ë¶„ì„ ê²°ê³¼', 'ê±°ë˜ì²˜ì›ì¥ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ui.ButtonSet.OK);
    return;
  }
  
  let report = 'ğŸ“Š ê±°ë˜ì²˜ì›ì¥ ë¶„ì„ ë³´ê³ ì„œ\n';
  report += `ê¸°ì¤€: ${baseDate.year}ë…„ ${baseDate.month}ì›”\n\n`;
  
  ledgerSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const sheetType = detectSheetType(sheetName);
    const isTaxable = sheetType === 'ì•½í’ˆ_ê³¼ì„¸';
    
    report += `\nğŸ“‹ ${sheetName}\n`;
    report += `  ğŸ“Œ íƒ€ì…: ${sheetType}\n`;
    
    if (isTaxable) {
      report += `  âš ï¸ ê³¼ì„¸ ì‹œíŠ¸ (ë‹¨ê°€ì— VAT í¬í•¨)\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— (ë‹¨ê°€Ã·1.1)\n`;
    } else if (sheetType === 'ì•½í’ˆ_ì˜ì„¸') {
      report += `  âœ… ì˜ì„¸ ì‹œíŠ¸ (VAT 0%)\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n`;
    } else {
      report += `  âœ… ì¼ë°˜ ì‹œíŠ¸\n`;
      report += `     â†’ ê³µê¸‰ê°€ì•¡ = ìˆ˜ëŸ‰ Ã— ë‹¨ê°€\n`;
    }
    
    const dataInfo = findDataRangeWithTitle(sheet);
    if (dataInfo) {
      report += `  âœ… ë°ì´í„° ì˜ì—­: ${dataInfo.startRow}~${dataInfo.endRow}í–‰\n`;
      report += `  âœ… í—¤ë” ìœ„ì¹˜: ${dataInfo.headerRow}í–‰\n`;
      
      const headerInfo = analyzeHeaders(sheet, dataInfo.headerRow);
      if (headerInfo.valid) {
        report += `  âœ… í•„ìˆ˜ ì—´ í™•ì¸ë¨\n`;
        const weightType = headerInfo.columns.weight !== undefined ? 'ì¤‘ëŸ‰' : 
                          headerInfo.columns.spec !== undefined ? 'ê·œê²©' : 'ì—†ìŒ';
        report += `     - ${weightType}: ${headerInfo.columns.weight !== undefined || headerInfo.columns.spec !== undefined ? 'ìˆìŒ' : 'ì—†ìŒ'}\n`;
        report += `     - ìˆ˜ëŸ‰: ${headerInfo.columns.quantity !== undefined ? 'ìˆìŒ' : 'ì—†ìŒ'}\n`;
        report += `     - ë‹¨ê°€: ${headerInfo.columns.unitPrice !== undefined ? 'ìˆìŒ' : 'ì—†ìŒ'}\n`;
      } else {
        report += `  âŒ í•„ìˆ˜ ì—´ ëˆ„ë½\n`;
      }
    } else {
      report += `  âŒ ë°ì´í„° ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ\n`;
    }
  });
  
  // êµ¬ë§¤ë‚´ì—­ì„œ ê²€ì¦ ê°€ëŠ¥ ì—¬ë¶€
  const targetSheetName = `${baseDate.monthShort}ì›” êµ¬ë§¤ë‚´ì—­ì„œ_${baseDate.yearShort}.${baseDate.monthShort}ì›” êµ¬ë§¤ë‚´ì—­ì„œ`;
  report += `\n\nğŸ” êµ¬ë§¤ë‚´ì—­ì„œ ê²€ì¦:\n`;
  report += `  ì°¾ì„ ì‹œíŠ¸: ${targetSheetName}\n`;
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  if (spreadsheet.getSheetByName(targetSheetName)) {
    report += `  âœ… êµ¬ë§¤ë‚´ì—­ì„œ ì‹œíŠ¸ ì¡´ì¬\n`;
  } else {
    report += `  âŒ êµ¬ë§¤ë‚´ì—­ì„œ ì‹œíŠ¸ ì—†ìŒ\n`;
  }
  
  ui.alert('ê±°ë˜ì²˜ì›ì¥ ë¶„ì„', report, ui.ButtonSet.OK);
}
